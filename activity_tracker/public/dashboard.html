<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Activity Dashboard</title>
  <style>
    :root{
      --bg:#0e1117; --header:#1f2937; --row:#121826; --rowHover:#182235; --muted:#9aa3af; --text:#e5e7eb; --border:#2b3546;
    }
    html,body{background:var(--bg); color:var(--text); margin:0;}
    h1{margin:24px 16px 8px; text-align:center;}
    .table-wrap{
      margin:0 16px 24px;
      max-height:80vh; overflow-y:auto; overflow-x:auto;
      border:1px solid var(--border); border-radius:8px;
    }
    table{width:100%; border-collapse:collapse;}
    thead th{
      background:var(--header); color:var(--text);
      position:sticky; top:0; z-index:2;
      padding:10px; text-align:center; font-weight:700; cursor:pointer; white-space:nowrap;
      border-bottom:1px solid var(--border);
    }
    tbody td{
      text-align:center; padding:10px 8px; border-bottom:1px solid var(--border);
      background:var(--row);
    }
    tbody tr:hover td{background:var(--rowHover);}
    .muted{color:var(--muted);}
    .sort-asc::after{content:" ▲"; font-size:.8em;}
    .sort-desc::after{content:" ▼"; font-size:.8em;}
    .empty{padding:24px; text-align:center; color:var(--muted);}
  </style>
</head>
<body>
  <h1>Activity Dashboard</h1>

  <div class="table-wrap">
    <table id="activityTable">
      <thead>
        <tr>
          <th data-col="0">Date</th>
          <th data-col="1">Steps</th>
          <th data-col="2">Active kcal</th>
          <th data-col="3">Total kcal</th>
          <th data-col="4"># Workouts</th>
          <th data-col="5">Minutes</th>
          <th data-col="6">Workout Names</th>
        </tr>
      </thead>
      <tbody id="activityBody">
        <tr><td colspan="7" class="empty muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const table = document.getElementById("activityTable");
    const tbody = document.getElementById("activityBody");
    const headers = table.querySelectorAll("th");
    let sortState = { col: 0, dir: "desc" }; // default: date desc

    const num = (v) => {
      const t = String(v ?? "").replace(/,/g, "").trim();
      const n = Number(t);
      return Number.isFinite(n) ? n : NaN;
    };

    function renderRows(rows){
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td class="empty muted" colspan="7">No data</td></tr>`;
        return;
      }
      const frag = document.createDocumentFragment();
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.steps ?? 0}</td>
          <td>${(r.activeKcal ?? 0)}</td>
          <td>${(r.totalKcal ?? 0)}</td>
          <td>${r.workoutCount ?? 0}</td>
          <td>${(r.workoutMinutes ?? 0).toFixed(1)}</td>
          <td>${(r.workoutNames ?? []).join(", ")}</td>
        `;
        frag.appendChild(tr);
      });
      tbody.innerHTML = "";
      tbody.appendChild(frag);
    }

    function sortTable(col, dir){
      const rows = Array.from(tbody.querySelectorAll("tr")).filter(tr => !tr.querySelector(".empty"));
      if (!rows.length) return;

      const isNumericCol = col !== 0 && col !== 6; // date and names are strings
      rows.sort((a,b)=>{
        let A = a.children[col].textContent.trim();
        let B = b.children[col].textContent.trim();
        if (isNumericCol){
          A = num(A); B = num(B);
          if (Number.isNaN(A)) A = -Infinity;
          if (Number.isNaN(B)) B = -Infinity;
        }
        if (dir === "asc") return A > B ? 1 : (A < B ? -1 : 0);
        return A < B ? 1 : (A > B ? -1 : 0);
      });

      tbody.innerHTML = "";
      rows.forEach(r=>tbody.appendChild(r));

      headers.forEach(h=>h.classList.remove("sort-asc","sort-desc"));
      const hdr = [...headers].find(h=>h.dataset.col == col);
      hdr && hdr.classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
    }

    headers.forEach(h=>{
      h.addEventListener("click", ()=>{
        const col = Number(h.dataset.col);
        const dir = (sortState.col === col && sortState.dir === "asc") ? "desc" : "asc";
        sortState = { col, dir };
        sortTable(col, dir);
      });
    });

    async function fetchData(){
      try{
        // FIX: correct API and include credentials (Basic Auth is already established)
        const res = await fetch("/api/daily", { credentials: "same-origin" });
        if (!res.ok){
          tbody.innerHTML = `<tr><td class="empty muted" colspan="7">Error ${res.status}: ${res.statusText}</td></tr>`;
          return;
        }
        const data = await res.json();
        renderRows(data);
        // default sort: Date desc
        sortTable(sortState.col, sortState.dir);
      }catch(e){
        tbody.innerHTML = `<tr><td class="empty muted" colspan="7">Failed to load data</td></tr>`;
        console.error(e);
      }
    }

    fetchData();
  </script>
</body>
</html>