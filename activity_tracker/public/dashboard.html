<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Activity Dashboard</title>

  <style>
    :root{
      --bg:#0f1115;--card:#151924;--text:#eaeef7;--muted:#a6b1c2;
      --accent:#5aa6ff;--accent2:#ff7b72;--accent3:#4ac7a5;--border:#2a3142;
    }
    html,body{background:var(--bg);color:var(--text)}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:2rem}
    h1{margin:0 0 1rem}.subtle{color:var(--muted);margin:0 0 2rem}

    .card{
      background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:16px;margin-bottom:20px;box-shadow:0 6px 24px rgba(0,0,0,.25)
    }
    canvas{max-width:100%;height:360px}

    /* DataTable dark styling + centered text */
    table.dataTable.table-dark{width:100%!important;border-collapse:separate;border-spacing:0}
    table.dataTable.table-dark thead th{
      background:#1b2130;color:var(--text);border-bottom:1px solid var(--border);
      text-align:center;position:relative
    }
    table.dataTable.table-dark tbody td{
      color:var(--text);border-top:1px solid var(--border);background:var(--card);text-align:center
    }
    table.dataTable.table-dark tbody tr:hover td{background:#1a2030}
    .dt-search input,.dt-length select{
      background:#121622;color:var(--text);border:1px solid var(--border);
      border-radius:8px;padding:6px 10px
    }
    .dt-paging .dt-paging-button{
      background:#121622;color:var(--text);border:1px solid var(--border);
      padding:6px 10px;margin:0 2px;border-radius:6px
    }
    .dt-paging .dt-paging-button.current{background:var(--accent);border-color:var(--accent);color:#041423}

    /* FixedHeader (keeps header visible while page scrolls) */
    table.dataTable.table-dark thead th,
    table.dataTable.table-dark thead td{white-space:nowrap}
    div.fixedHeader-floating{
      background:#1b2130;border-bottom:1px solid var(--border);box-shadow:0 6px 24px rgba(0,0,0,.35);
      z-index:1000
    }
    div.fixedHeader-floating th{background:#1b2130 !important;color:var(--text)!important}

    /* CSS fallback if FixedHeader can‚Äôt attach (rare) */
    table.sticky-head thead th{position:sticky;top:0;z-index:5}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- DataTables v2 (vanilla, no jQuery) + FixedHeader v4 -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css?v=2008">
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js?v=2008"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/4.0.1/css/fixedHeader.dataTables.min.css?v=401">
  <script src="https://cdn.datatables.net/fixedheader/4.0.1/js/dataTables.fixedHeader.min.js?v=401"></script>
</head>
<body>
  <h1>üèÉ‚Äç‚ôÇÔ∏è Daily Activity Overview</h1>
  <p class="subtle">‚ÄúTotal kcal‚Äù = Active kcal + 1745 (fixed baseline)</p>

  <div class="card">
    <canvas id="stepsChart"></canvas>
  </div>

  <div class="card">
    <canvas id="kcalChart"></canvas>
  </div>

  <div class="card">
    <table id="data" class="display table-dark sticky-head" style="width:100%">
      <thead>
        <tr>
          <th>Date</th>
          <th>Steps</th>
          <th>Active kcal</th>
          <th>Total kcal</th>
          <th># Workouts</th>
          <th>Minutes</th>
          <th>Workout Names</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
async function getData(){
  const res = await fetch('/api/daily', { credentials: 'same-origin' });
  return res.json();
}
function ddmmyyyy(iso){ const [y,m,d]=iso.split('-'); return `${d}-${m}-${y}`; }

(async () => {
  // Safety: wait until DataTables is actually present
  if (typeof window.DataTable === 'undefined') {
    console.error('DataTables not loaded. Check CDN/network.');
  }

  const data = await getData();
  // Show newest dates first across charts and table
  const sorted = [...data].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());

  /* -------- Charts -------- */
  const labels = sorted.map(r => ddmmyyyy(r.date));

  const stepsCtx = document.getElementById('stepsChart').getContext('2d');
  const grad = stepsCtx.createLinearGradient(0,0,0,300);
  grad.addColorStop(0,'rgba(90,166,255,0.35)'); grad.addColorStop(1,'rgba(90,166,255,0.02)');
  new Chart(stepsCtx,{
    type:'line',
    data:{ labels, datasets:[{
      label:'Steps', data:sorted.map(r=>r.steps||0), borderColor:'#5aa6ff',
      backgroundColor:grad, pointRadius:0, borderWidth:2, tension:0.3, fill:true
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{labels:{color:'#eaeef7'}}, title:{display:true,text:'Daily Steps',color:'#eaeef7'}, tooltip:{mode:'index',intersect:false}},
      scales:{ x:{ticks:{color:'#a6b1c2'},grid:{color:'rgba(255,255,255,0.05)'}},
               y:{ticks:{color:'#a6b1c2'},grid:{color:'rgba(255,255,255,0.05)'}}}
    }
  });

  const kcalCtx = document.getElementById('kcalChart').getContext('2d');
  new Chart(kcalCtx,{
    type:'bar',
    data:{ labels,
      datasets:[
        { label:'Active kcal', data:sorted.map(r=>r.activeKcal||0), backgroundColor:'#4ac7a5' },
        { label:'Total kcal',  data:sorted.map(r=>r.totalKcal ||0), backgroundColor:'#ff7b72' }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{labels:{color:'#eaeef7'}}, title:{display:true,text:'Daily kcal (Active vs Total)',color:'#eaeef7'}, tooltip:{mode:'index',intersect:false}},
      scales:{ x:{ticks:{color:'#a6b1c2'},grid:{color:'rgba(255,255,255,0.05)'}},
               y:{ticks:{color:'#a6b1c2'},grid:{color:'rgba(255,255,255,0.05)'}}}
    }
  });

  /* -------- Table -------- */
  const tbody = document.querySelector('#data tbody');
  tbody.innerHTML = sorted.map(r => `
    <tr>
      <!-- use data-order with ISO date so sorting works by real date -->
      <td data-order="${r.date}">${ddmmyyyy(r.date)}</td>
      <td data-order="${r.steps ?? 0}">${r.steps ?? 0}</td>
      <td data-order="${r.activeKcal ?? 0}">${(r.activeKcal ?? 0).toFixed(0)}</td>
      <td data-order="${r.totalKcal ?? 0}">${(r.totalKcal ?? 0).toFixed(0)}</td>
      <td data-order="${r.workoutCount ?? 0}">${r.workoutCount ?? 0}</td>
      <td data-order="${r.workoutMinutes ?? 0}">${(r.workoutMinutes ?? 0).toFixed(1)}</td>
      <td>${(r.workoutNames ?? []).join(', ')}</td>
    </tr>
  `).join('');

  new DataTable('#data',{
    order: [[0,'desc']],            // default: newest date first
    ordering: true,                 // click any header to sort asc/desc
    autoWidth: false,
    pageLength: 25,
    lengthMenu: [10,25,50,100],
    fixedHeader: true,              // keep header visible during scroll
    layout:{
      topStart:'search',
      topEnd:'pageLength',
      bottomStart:'info',
      bottomEnd:'paging'
    },
    columnDefs:[
      { targets: '_all', className: 'dt-head-center dt-body-center' },
      { targets: [1,2,3,4,5], type: 'num' }
    ]
  });
})();
</script>
</body>
</html>
