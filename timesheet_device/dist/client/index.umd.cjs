(function(Q,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],f):(Q=typeof globalThis<"u"?globalThis:Q||self,f(Q.TimesheetDeviceUI={},Q.React))})(this,function(Q,f){"use strict";var Ae={exports:{}},pe={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ze;function pt(){if(Ze)return pe;Ze=1;var l=f,d=Symbol.for("react.element"),b=Symbol.for("react.fragment"),p=Object.prototype.hasOwnProperty,T=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,O={key:!0,ref:!0,__self:!0,__source:!0};function S(D,w,Y){var N,k={},B=null,A=null;Y!==void 0&&(B=""+Y),w.key!==void 0&&(B=""+w.key),w.ref!==void 0&&(A=w.ref);for(N in w)p.call(w,N)&&!O.hasOwnProperty(N)&&(k[N]=w[N]);if(D&&D.defaultProps)for(N in w=D.defaultProps,w)k[N]===void 0&&(k[N]=w[N]);return{$$typeof:d,type:D,key:B,ref:A,props:k,_owner:T.current}}return pe.Fragment=b,pe.jsx=S,pe.jsxs=S,pe}var he={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var qe;function ht(){return qe||(qe=1,process.env.NODE_ENV!=="production"&&function(){var l=f,d=Symbol.for("react.element"),b=Symbol.for("react.portal"),p=Symbol.for("react.fragment"),T=Symbol.for("react.strict_mode"),O=Symbol.for("react.profiler"),S=Symbol.for("react.provider"),D=Symbol.for("react.context"),w=Symbol.for("react.forward_ref"),Y=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),k=Symbol.for("react.memo"),B=Symbol.for("react.lazy"),A=Symbol.for("react.offscreen"),ge=Symbol.iterator,De="@@iterator";function H(e){if(e===null||typeof e!="object")return null;var n=ge&&e[ge]||e[De];return typeof n=="function"?n:null}var K=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function j(e){{for(var n=arguments.length,i=new Array(n>1?n-1:0),m=1;m<n;m++)i[m-1]=arguments[m];Ve("error",e,i)}}function Ve(e,n,i){{var m=K.ReactDebugCurrentFrame,y=m.getStackAddendum();y!==""&&(n+="%s",i=i.concat([y]));var E=i.map(function(g){return String(g)});E.unshift("Warning: "+n),Function.prototype.apply.call(console[e],console,E)}}var re=!1,We=!1,Ne=!1,ye=!1,W=!1,ae;ae=Symbol.for("react.module.reference");function we(e){return!!(typeof e=="string"||typeof e=="function"||e===p||e===O||W||e===T||e===Y||e===N||ye||e===A||re||We||Ne||typeof e=="object"&&e!==null&&(e.$$typeof===B||e.$$typeof===k||e.$$typeof===S||e.$$typeof===D||e.$$typeof===w||e.$$typeof===ae||e.getModuleId!==void 0))}function se(e,n,i){var m=e.displayName;if(m)return m;var y=n.displayName||n.name||"";return y!==""?i+"("+y+")":i}function X(e){return e.displayName||"Context"}function L(e){if(e==null)return null;if(typeof e.tag=="number"&&j("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case p:return"Fragment";case b:return"Portal";case O:return"Profiler";case T:return"StrictMode";case Y:return"Suspense";case N:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case D:var n=e;return X(n)+".Consumer";case S:var i=e;return X(i._context)+".Provider";case w:return se(e,e.render,"ForwardRef");case k:var m=e.displayName||null;return m!==null?m:L(e.type)||"Memo";case B:{var y=e,E=y._payload,g=y._init;try{return L(g(E))}catch{return null}}}return null}var J=Object.assign,Z=0,Ee,_e,q,Se,F,oe,Te;function $(){}$.__reactDisabledLog=!0;function ie(){{if(Z===0){Ee=console.log,_e=console.info,q=console.warn,Se=console.error,F=console.group,oe=console.groupCollapsed,Te=console.groupEnd;var e={configurable:!0,enumerable:!0,value:$,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}Z++}}function le(){{if(Z--,Z===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:J({},e,{value:Ee}),info:J({},e,{value:_e}),warn:J({},e,{value:q}),error:J({},e,{value:Se}),group:J({},e,{value:F}),groupCollapsed:J({},e,{value:oe}),groupEnd:J({},e,{value:Te})})}Z<0&&j("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var ee=K.ReactCurrentDispatcher,xe;function ce(e,n,i){{if(xe===void 0)try{throw Error()}catch(y){var m=y.stack.trim().match(/\n( *(at )?)/);xe=m&&m[1]||""}return`
`+xe+e}}var Re=!1,ue;{var Be=typeof WeakMap=="function"?WeakMap:Map;ue=new Be}function Le(e,n){if(!e||Re)return"";{var i=ue.get(e);if(i!==void 0)return i}var m;Re=!0;var y=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var E;E=ee.current,ee.current=null,ie();try{if(n){var g=function(){throw Error()};if(Object.defineProperty(g.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(g,[])}catch(M){m=M}Reflect.construct(e,[],g)}else{try{g.call()}catch(M){m=M}e.call(g.prototype)}}else{try{throw Error()}catch(M){m=M}e()}}catch(M){if(M&&m&&typeof M.stack=="string"){for(var v=M.stack.split(`
`),P=m.stack.split(`
`),R=v.length-1,C=P.length-1;R>=1&&C>=0&&v[R]!==P[C];)C--;for(;R>=1&&C>=0;R--,C--)if(v[R]!==P[C]){if(R!==1||C!==1)do if(R--,C--,C<0||v[R]!==P[C]){var V=`
`+v[R].replace(" at new "," at ");return e.displayName&&V.includes("<anonymous>")&&(V=V.replace("<anonymous>",e.displayName)),typeof e=="function"&&ue.set(e,V),V}while(R>=1&&C>=0);break}}}finally{Re=!1,ee.current=E,le(),Error.prepareStackTrace=y}var me=e?e.displayName||e.name:"",te=me?ce(me):"";return typeof e=="function"&&ue.set(e,te),te}function He(e,n,i){return Le(e,!1)}function Je(e){var n=e.prototype;return!!(n&&n.isReactComponent)}function fe(e,n,i){if(e==null)return"";if(typeof e=="function")return Le(e,Je(e));if(typeof e=="string")return ce(e);switch(e){case Y:return ce("Suspense");case N:return ce("SuspenseList")}if(typeof e=="object")switch(e.$$typeof){case w:return He(e.render);case k:return fe(e.type,n,i);case B:{var m=e,y=m._payload,E=m._init;try{return fe(E(y),n,i)}catch{}}}return""}var G=Object.prototype.hasOwnProperty,Oe={},ke=K.ReactDebugCurrentFrame;function z(e){if(e){var n=e._owner,i=fe(e.type,e._source,n?n.type:null);ke.setExtraStackFrame(i)}else ke.setExtraStackFrame(null)}function t(e,n,i,m,y){{var E=Function.call.bind(G);for(var g in e)if(E(e,g)){var v=void 0;try{if(typeof e[g]!="function"){var P=Error((m||"React class")+": "+i+" type `"+g+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[g]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw P.name="Invariant Violation",P}v=e[g](n,g,m,i,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(R){v=R}v&&!(v instanceof Error)&&(z(y),j("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",m||"React class",i,g,typeof v),z(null)),v instanceof Error&&!(v.message in Oe)&&(Oe[v.message]=!0,z(y),j("Failed %s type: %s",i,v.message),z(null))}}}var r=Array.isArray;function a(e){return r(e)}function c(e){{var n=typeof Symbol=="function"&&Symbol.toStringTag,i=n&&e[Symbol.toStringTag]||e.constructor.name||"Object";return i}}function o(e){try{return s(e),!1}catch{return!0}}function s(e){return""+e}function h(e){if(o(e))return j("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",c(e)),s(e)}var _=K.ReactCurrentOwner,x={key:!0,ref:!0,__self:!0,__source:!0},I,U;function Ge(e){if(G.call(e,"ref")){var n=Object.getOwnPropertyDescriptor(e,"ref").get;if(n&&n.isReactWarning)return!1}return e.ref!==void 0}function Pe(e){if(G.call(e,"key")){var n=Object.getOwnPropertyDescriptor(e,"key").get;if(n&&n.isReactWarning)return!1}return e.key!==void 0}function Ct(e,n){typeof e.ref=="string"&&_.current}function Dt(e,n){{var i=function(){I||(I=!0,j("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",n))};i.isReactWarning=!0,Object.defineProperty(e,"key",{get:i,configurable:!0})}}function Nt(e,n){{var i=function(){U||(U=!0,j("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",n))};i.isReactWarning=!0,Object.defineProperty(e,"ref",{get:i,configurable:!0})}}var Lt=function(e,n,i,m,y,E,g){var v={$$typeof:d,type:e,key:n,ref:i,props:g,_owner:E};return v._store={},Object.defineProperty(v._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(v,"_self",{configurable:!1,enumerable:!1,writable:!1,value:m}),Object.defineProperty(v,"_source",{configurable:!1,enumerable:!1,writable:!1,value:y}),Object.freeze&&(Object.freeze(v.props),Object.freeze(v)),v};function Ot(e,n,i,m,y){{var E,g={},v=null,P=null;i!==void 0&&(h(i),v=""+i),Pe(n)&&(h(n.key),v=""+n.key),Ge(n)&&(P=n.ref,Ct(n,y));for(E in n)G.call(n,E)&&!x.hasOwnProperty(E)&&(g[E]=n[E]);if(e&&e.defaultProps){var R=e.defaultProps;for(E in R)g[E]===void 0&&(g[E]=R[E])}if(v||P){var C=typeof e=="function"?e.displayName||e.name||"Unknown":e;v&&Dt(g,C),P&&Nt(g,C)}return Lt(e,v,P,y,m,_.current,g)}}var ze=K.ReactCurrentOwner,it=K.ReactDebugCurrentFrame;function de(e){if(e){var n=e._owner,i=fe(e.type,e._source,n?n.type:null);it.setExtraStackFrame(i)}else it.setExtraStackFrame(null)}var Ke;Ke=!1;function Xe(e){return typeof e=="object"&&e!==null&&e.$$typeof===d}function lt(){{if(ze.current){var e=L(ze.current.type);if(e)return`

Check the render method of \``+e+"`."}return""}}function kt(e){return""}var ct={};function Pt(e){{var n=lt();if(!n){var i=typeof e=="string"?e:e.displayName||e.name;i&&(n=`

Check the top-level render call using <`+i+">.")}return n}}function ut(e,n){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var i=Pt(n);if(ct[i])return;ct[i]=!0;var m="";e&&e._owner&&e._owner!==ze.current&&(m=" It was passed a child from "+L(e._owner.type)+"."),de(e),j('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',i,m),de(null)}}function ft(e,n){{if(typeof e!="object")return;if(a(e))for(var i=0;i<e.length;i++){var m=e[i];Xe(m)&&ut(m,n)}else if(Xe(e))e._store&&(e._store.validated=!0);else if(e){var y=H(e);if(typeof y=="function"&&y!==e.entries)for(var E=y.call(e),g;!(g=E.next()).done;)Xe(g.value)&&ut(g.value,n)}}}function At(e){{var n=e.type;if(n==null||typeof n=="string")return;var i;if(typeof n=="function")i=n.propTypes;else if(typeof n=="object"&&(n.$$typeof===w||n.$$typeof===k))i=n.propTypes;else return;if(i){var m=L(n);t(i,e.props,"prop",m,e)}else if(n.PropTypes!==void 0&&!Ke){Ke=!0;var y=L(n);j("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",y||"Unknown")}typeof n.getDefaultProps=="function"&&!n.getDefaultProps.isReactClassApproved&&j("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function Mt(e){{for(var n=Object.keys(e.props),i=0;i<n.length;i++){var m=n[i];if(m!=="children"&&m!=="key"){de(e),j("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",m),de(null);break}}e.ref!==null&&(de(e),j("Invalid attribute `ref` supplied to `React.Fragment`."),de(null))}}var dt={};function mt(e,n,i,m,y,E){{var g=we(e);if(!g){var v="";(e===void 0||typeof e=="object"&&e!==null&&Object.keys(e).length===0)&&(v+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var P=kt();P?v+=P:v+=lt();var R;e===null?R="null":a(e)?R="array":e!==void 0&&e.$$typeof===d?(R="<"+(L(e.type)||"Unknown")+" />",v=" Did you accidentally export a JSX literal instead of a component?"):R=typeof e,j("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",R,v)}var C=Ot(e,n,i,y,E);if(C==null)return C;if(g){var V=n.children;if(V!==void 0)if(m)if(a(V)){for(var me=0;me<V.length;me++)ft(V[me],e);Object.freeze&&Object.freeze(V)}else j("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else ft(V,e)}if(G.call(n,"key")){var te=L(e),M=Object.keys(n).filter(function(Wt){return Wt!=="key"}),Qe=M.length>0?"{key: someKey, "+M.join(": ..., ")+": ...}":"{key: someKey}";if(!dt[te+Qe]){var Vt=M.length>0?"{"+M.join(": ..., ")+": ...}":"{}";j(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,Qe,te,Vt,te),dt[te+Qe]=!0}}return e===p?Mt(C):At(C),C}}function Ft(e,n,i){return mt(e,n,i,!0)}function It(e,n,i){return mt(e,n,i,!1)}var Yt=It,Ut=Ft;he.Fragment=p,he.jsx=Yt,he.jsxs=Ut}()),he}process.env.NODE_ENV==="production"?Ae.exports=pt():Ae.exports=ht();var u=Ae.exports;const Me={},$e="/api/imu/latest",vt="/api/imu/history",je=12,bt=1e3,Fe="dodec-labels",et=["dodeca-labels"],tt="dodec-activity-log",gt="Side",yt=24*60*60*1e3,Ie="DODEC_LABEL_UPDATE",nt="DODEC_LABELS_REQUEST",rt=(()=>{const l=Me==null?void 0:Me.VITE_DEVICE_LABELS_URL;if(l&&l.length>0)return l;try{const d=new URL($e,"https://placeholder.local");return`${d.origin==="https://placeholder.local"?"":`${d.protocol}//${d.host}`}/api/labels`}catch{return"/api/labels"}})(),wt=Array.from({length:je},(l,d)=>d+1),Ye=()=>{const l={};for(const d of wt)l[d]="";return l},Et=()=>{if(typeof window>"u")return Ye();const l=b=>{try{const p=window.localStorage.getItem(b);if(!p)return null;const T=JSON.parse(p),O=Ye();for(const[S,D]of Object.entries(T)){const w=Number(S);Number.isFinite(w)&&w>=1&&w<=je&&(O[w]=String(D??""))}return O}catch(p){return console.warn("Unable to read stored labels",p),null}},d=l(Fe);if(d)return d;for(const b of et){const p=l(b);if(p){try{window.localStorage.setItem(Fe,JSON.stringify(p))}catch{}return p}}return Ye()},at=()=>({currentLabel:null,startTime:null,lastTimestamp:null,lastSide:null}),Ue=(l,d)=>{var p;const b=(p=l[d])==null?void 0:p.trim();return b&&b.length>0?b:`${gt} ${d}`},_t=l=>{const d=[l.received_at,l.imu_timestamp_iso];for(const b of d)if(b){const p=Date.parse(b);if(!Number.isNaN(p))return p}if(l.imu_timestamp_text){const b=l.imu_timestamp_text.replace(" ","T"),p=Date.parse(b);if(!Number.isNaN(p))return p}return Date.now()},St=l=>{if(!l)return null;const d=Date.parse(l);return Number.isNaN(d)?null:d},ne=l=>{const d=new Date(l),b=d.getFullYear(),p=String(d.getMonth()+1).padStart(2,"0"),T=String(d.getDate()).padStart(2,"0");return`${b}-${p}-${T}`},ve=l=>{const[d,b,p]=l.split("-").map(Number);return new Date(d,b-1,p)},Ce=l=>{const d=ve(l),b=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(),p=b+yt;return{start:b,end:p}},st=l=>{const d=ve(l);return new Intl.DateTimeFormat(void 0,{dateStyle:"medium"}).format(d)},Tt=l=>l?l.replace("T"," ").replace(/\+.*$/,""):"Waiting for data?",be=l=>{if(!Number.isFinite(l)||l<=0)return"00:00";const d=Math.floor(l/1e3),b=Math.floor(d/3600),p=Math.floor(d%3600/60),T=d%60;return b>0?`${String(b).padStart(2,"0")}:${String(p).padStart(2,"0")}:${String(T).padStart(2,"0")}`:`${String(p).padStart(2,"0")}:${String(T).padStart(2,"0")}`},xt=l=>be(l),Rt=l=>{const d=l.trim();if(!d)return NaN;const b=d.split(":");if(b.length>1){if(b.length>3)return NaN;const T=b.map(w=>Number(w));if(T.some(w=>Number.isNaN(w)||w<0))return NaN;let O=0,S=0,D=0;return T.length===3?[O,S,D]=T:[S,D]=T,Math.max(0,O*3600+S*60+D)*1e3}const p=Number(d);return Number.isNaN(p)||p<0?NaN:p*60*1e3},ot=l=>l.includes('"')||l.includes(",")||l.includes(`
`)?`"${l.replace(/"/g,'""')}"`:l;function jt(){const[l,d]=f.useState(null),[b,p]=f.useState(null),[T,O]=f.useState(()=>{if(typeof window>"u")return{};try{const t=window.localStorage.getItem(tt);return t?JSON.parse(t):{}}catch(t){return console.warn("Unable to read stored activity log",t),{}}}),[S,D]=f.useState(null),[w,Y]=f.useState(""),[N,k]=f.useState(""),[B,A]=f.useState(null),[ge,De]=f.useState(()=>[ne(Date.now())]),[H,K]=f.useState("week"),[j,Ve]=f.useState(ne(Date.now())),[re,We]=f.useState(ne(Date.now())),[Ne,ye]=f.useState(null),[W,ae]=f.useState(()=>Et()),we=f.useRef(W),se=f.useRef(!1),X=f.useRef({}),L=f.useRef(at()),[J,Z]=f.useState(!1),Ee=f.useCallback((t,r,a)=>{a<=r||O(c=>{const o={...c};let s=r;for(;s<a;){const h=ne(s),{end:_}=Ce(h),x=Math.min(a,_),I=Math.max(0,x-s);if(I>0){const U={...o[h]??{}};U[t]=(U[t]??0)+I,o[h]=U}s=x}return o})},[]),_e=f.useCallback(()=>{L.current=at(),O(()=>({}))},[]),q=f.useCallback(t=>{const r=typeof t.side=="number"?t.side:null;if(!r)return;const a=Ue(we.current,r),c=_t(t),o=t.segment_started_at?St(t.segment_started_at):null,s=L.current;if(s.currentLabel===null||s.startTime===null){s.currentLabel=a,s.startTime=o??c,s.lastTimestamp=c,s.lastSide=r;return}if(a===s.currentLabel){o!==null&&(s.startTime===null||o<s.startTime)&&(s.startTime=o),s.lastTimestamp=c,s.lastSide=r;return}const h=s.startTime,_=c;_>h&&Ee(s.currentLabel,h,_),s.currentLabel=a,s.startTime=o??c,s.lastTimestamp=c,s.lastSide=r},[Ee]);f.useEffect(()=>{if(we.current=W,typeof window<"u"){const r=JSON.stringify(W);window.localStorage.setItem(Fe,r);for(const a of et)window.localStorage.setItem(a,r);!se.current&&window.parent&&window.parent!==window&&window.parent.postMessage({type:Ie,labels:W},"*")}se.current=!1;const t=L.current;t.lastSide!==null&&(t.currentLabel=Ue(W,t.lastSide))},[W]),f.useEffect(()=>{typeof window<"u"&&window.localStorage.setItem(tt,JSON.stringify(T))},[T]),f.useEffect(()=>()=>{if(!(typeof window>"u"))for(const t of Object.keys(X.current)){const r=X.current[Number(t)];typeof r=="number"&&window.clearTimeout(r)}},[]),f.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(rt,{cache:"no-store"});if(!a.ok)throw new Error(`Failed to load labels (status ${a.status})`);const c=await a.json();if(t||!c||typeof c.labels!="object"||c.labels===null)return;se.current=!0,ae(o=>{const s={...o};let h=!1;for(const[_,x]of Object.entries(c.labels)){const I=Number(_);if(!Number.isFinite(I)||I<1||I>je)continue;const U=typeof x=="string"?x:"";s[I]!==U&&(s[I]=U,h=!0)}return h?s:o})}catch(a){console.error("[timesheet-app] failed to load labels from server",a)}})(),()=>{t=!0}},[]),f.useEffect(()=>{if(typeof window>"u")return;const t=r=>{const a=r==null?void 0:r.data;if(!(!a||typeof a!="object"))if(a.type===Ie&&a.labels&&typeof a.labels=="object"){se.current=!0;const c=a.labels;ae(o=>{const s={...o};for(const[h,_]of Object.entries(c)){const x=Number(h);!Number.isFinite(x)||x<1||x>je||(s[x]=typeof _=="string"?_:"")}return{...s}})}else a.type===nt&&window.parent&&window.parent!==window&&window.parent.postMessage({type:Ie,labels:we.current},r.origin||"*")};return window.addEventListener("message",t),window.parent&&window.parent!==window&&window.parent.postMessage({type:nt},"*"),()=>{window.removeEventListener("message",t)}},[]),f.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(`${vt}?limit=5000`,{cache:"no-store"});if(!a.ok)throw new Error(`History request failed with status ${a.status}`);const c=await a.json();if(t)return;_e();let o=null;for(const s of c){if(t)break;q(s),o=s}o&&d({side:typeof o.side=="number"?o.side:null,imu_timestamp_text:o.imu_timestamp_text??null,imu_timestamp_iso:o.imu_timestamp_iso??null,received_at:o.received_at??null,confidence:o.confidence??null}),p(null)}catch(a){t||p(a instanceof Error?a.message:"Unknown error while loading history")}finally{t||Z(!0)}})(),()=>{t=!0}},[q,_e]),f.useEffect(()=>{if(!J)return;let t=!0;const r=async()=>{try{const c=await fetch($e,{cache:"no-store"});if(!c.ok)throw new Error(`Request failed with status ${c.status}`);const o=await c.json();if(!t)return;q(o),d({side:typeof o.side=="number"?o.side:null,imu_timestamp_text:o.imu_timestamp_text??null,imu_timestamp_iso:o.imu_timestamp_iso??null,received_at:o.received_at??null,confidence:o.confidence??null}),p(null)}catch(c){t&&p(c instanceof Error?c.message:"Unknown error")}};r();const a=window.setInterval(r,bt);return()=>{t=!1,window.clearInterval(a)}},[q,J]);const Se=L.current,F=Se.lastTimestamp?ne(Se.lastTimestamp):ne(Date.now());f.useEffect(()=>{De(t=>t.includes(F)?t:[...t,F])},[F]);const oe=f.useCallback(async(t,r)=>{try{const a=await fetch(`${rt.replace(/\/$/,"")}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:r})});if(!a.ok)throw new Error(`Failed to persist label (status ${a.status})`)}catch(a){console.error(`[timesheet-app] failed to persist label for side ${t}`,a)}},[]),Te=f.useCallback((t,r)=>{const a=r.trim();if(typeof window>"u"){oe(t,a);return}const c=X.current[t];typeof c=="number"&&window.clearTimeout(c),X.current[t]=window.setTimeout(()=>{X.current[t]=null,oe(t,a)},400)},[oe]);f.useCallback(t=>r=>{const a=r.target.value;ae(c=>({...c,[t]:a})),Te(t,a)},[Te]);const $=(t,r)=>{const a=L.current;if(!a.currentLabel||a.currentLabel!==r||a.startTime===null||a.lastTimestamp===null)return 0;const{start:c,end:o}=Ce(t),s=Math.max(c,a.startTime),h=Math.min(o,a.lastTimestamp);return h>s?h-s:0},ie=f.useCallback(t=>{const r=T[t]??{},a=Object.entries(r).map(([o,s])=>({label:o,totalMs:s})),c=L.current;if(c.currentLabel&&c.startTime!==null&&c.lastTimestamp!==null){const o=$(t,c.currentLabel);if(o>0){const s=a.find(h=>h.label===c.currentLabel);s?s.totalMs+=o:a.push({label:c.currentLabel,totalMs:o})}}return a.sort((o,s)=>s.totalMs-o.totalMs)},[T,l]),le=f.useMemo(()=>{const t=new Set(Object.keys(T));return t.add(F),Array.from(t).sort((r,a)=>r===a?0:r>a?-1:1)},[T,F]),ee=f.useMemo(()=>le.map(t=>{const r=ie(t);if(r.length===0)return null;const a=r.reduce((c,o)=>c+o.totalMs,0);return{dateKey:t,rows:r,totalMs:a}}).filter(Boolean),[le,ie]),xe=f.useCallback((t,r,a)=>{if(L.current.currentLabel===r&&t===F){A("Stop the current activity before editing it.");return}D({dateKey:t,originalLabel:r}),Y(xt(a)),k(r),A(null)},[F]),ce=f.useCallback(t=>{Y(t.target.value)},[]),Re=f.useCallback(t=>{k(t.target.value)},[]),ue=f.useCallback(()=>{D(null),Y(""),k(""),A(null)},[]),Be=f.useCallback(()=>{if(!S)return;const{dateKey:t,originalLabel:r}=S,a=Rt(w);if(!Number.isFinite(a)){A("Please enter duration as mm:ss, hh:mm:ss, or minutes.");return}const c=N.trim();if(c.length===0){A("Activity name cannot be empty.");return}const o=$(t,r);if(a<o){A(`Duration cannot be less than the active segment (${be(o)}).`);return}const s=Math.max(0,a-o);O(h=>{const _={...h},x={..._[t]??{}};return r in x&&delete x[r],s>0&&(x[c]=(x[c]??0)+s),Object.keys(x).length===0?delete _[t]:_[t]=x,_}),D(null),Y(""),k(""),A(null)},[S,w,N,$]),Le=f.useCallback((t,r)=>{if($(t,r)>0){A("Stop the current activity before deleting it.");return}O(c=>{const o=c[t];if(!o||!(r in o))return c;const s={...c},h={...o};return delete h[r],Object.keys(h).length===0?delete s[t]:s[t]=h,s}),S&&S.dateKey===t&&S.originalLabel===r&&(D(null),Y(""),k("")),A(null)},[S]),He=f.useCallback(t=>{De(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])},[]),Je=()=>{if(H==="week"){const{start:o,end:s}=Ce(F),h=new Date(o);return h.setDate(h.getDate()-6),{start:new Date(h.getFullYear(),h.getMonth(),h.getDate()).getTime(),end:s}}if(H==="month"){const o=ve(F),s=new Date(o.getFullYear(),o.getMonth(),1).getTime(),h=new Date(o.getFullYear(),o.getMonth()+1,1).getTime();return{start:s,end:h}}const t=ve(j),r=ve(re);if(Number.isNaN(t.getTime())||Number.isNaN(r.getTime())||t>r)return null;const a=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime(),c=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1).getTime();return{start:a,end:c}},fe=f.useCallback(()=>{const t=Je();if(!t){ye("Please provide a valid date range before downloading.");return}const r=[];for(const _ of le){const{start:x,end:I}=Ce(_);if(I<=t.start||x>=t.end)continue;const U=ie(_);if(U.length===0)continue;const Ge=st(_);for(const Pe of U)r.push(`${ot(Ge)},${ot(Pe.label)},${be(Pe.totalMs)}`)}if(r.length===0){ye("No activity recorded in the selected range.");return}const a=["Date,Activity,Duration",...r].join(`
`),c=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(c),s=document.createElement("a");s.href=o;const h=H==="custom"?"custom":H;s.download=`activity-log-${h}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o),ye(null)},[ie,H,le,j,re]),G=(l==null?void 0:l.side)??null,Oe=f.useMemo(()=>G===null?null:Ue(W,G),[G,W]),ke=(l==null?void 0:l.imu_timestamp_text)??(l==null?void 0:l.imu_timestamp_iso)??(l==null?void 0:l.received_at)??null,z=f.useCallback(()=>{var c,o,s;if(typeof window>"u"||window.parent===window)return;const t=window.document,r=((c=t.documentElement)==null?void 0:c.scrollHeight)||((o=t.body)==null?void 0:o.scrollHeight)||window.innerHeight,a=Math.max(320,Math.min(Math.ceil(r),4e3));(s=window.parent)==null||s.postMessage({type:"EMBED_HEIGHT",height:a},"*")},[]);return f.useEffect(()=>{z()},[z,ee.length,ge,W,S,H]),f.useEffect(()=>{if(typeof window>"u")return;const t=()=>z();window.addEventListener("load",t),window.addEventListener("resize",t);let r=null;return typeof ResizeObserver<"u"&&(r=new ResizeObserver(t),r.observe(window.document.documentElement)),()=>{window.removeEventListener("load",t),window.removeEventListener("resize",t),r==null||r.disconnect()}},[z]),u.jsxs("div",{className:"app-shell",children:[u.jsxs("header",{className:"app-header",children:[u.jsx("h1",{children:"Do-Decahedron Orientation"}),u.jsxs("p",{className:"status-line",children:[u.jsx("span",{className:"status-label",children:"Latest IMU update:"}),u.jsx("span",{className:"status-value",children:Tt(ke)})]}),u.jsxs("p",{className:"status-line",children:[u.jsx("span",{className:"status-label",children:"Current activity:"}),u.jsx("span",{className:"status-value",children:Oe??"Waiting for data?"})]}),b?u.jsxs("p",{className:"error-text",children:["Error: ",b]}):null]}),u.jsxs("section",{className:"activity-summary","aria-live":"polite",children:[u.jsx("h2",{children:"Activity Log"}),u.jsxs("div",{className:"range-controls",children:[u.jsxs("label",{className:"range-option",children:["Range",u.jsxs("select",{className:"range-select",value:H,onChange:t=>K(t.target.value),children:[u.jsx("option",{value:"week",children:"This week"}),u.jsx("option",{value:"month",children:"This month"}),u.jsx("option",{value:"custom",children:"Custom"})]})]}),H==="custom"?u.jsxs(u.Fragment,{children:[u.jsxs("label",{className:"range-option",children:["From",u.jsx("input",{type:"date",className:"date-input",value:j,max:re,onChange:t=>Ve(t.target.value)})]}),u.jsxs("label",{className:"range-option",children:["To",u.jsx("input",{type:"date",className:"date-input",value:re,min:j,onChange:t=>We(t.target.value)})]})]}):null,u.jsx("button",{type:"button",className:"download-button",onClick:fe,children:"Download CSV"})]}),Ne?u.jsx("p",{className:"error-text",children:Ne}):null,ee.length===0?u.jsx("p",{className:"placeholder-text",children:"No activity recorded yet."}):ee.map(({dateKey:t,rows:r,totalMs:a})=>{const c=ge.includes(t),o=L.current;return u.jsxs("div",{className:"date-group",children:[u.jsxs("button",{type:"button",className:`date-header${c?" date-header--expanded":""}`,onClick:()=>He(t),children:[u.jsxs("div",{className:"date-header__title",children:[u.jsx("span",{className:"date-label",children:st(t)}),u.jsxs("span",{className:"date-summary",children:[r.length," activit",r.length===1?"y":"ies"," - ",be(a)]})]}),u.jsx("span",{className:"date-header__icon",children:c?"−":"+"})]}),c?u.jsxs("table",{className:"activity-table",children:[u.jsx("thead",{children:u.jsxs("tr",{children:[u.jsx("th",{scope:"col",children:"Activity"}),u.jsx("th",{scope:"col",children:"Total Duration"}),u.jsx("th",{scope:"col",className:"actions-heading",children:"Actions"})]})}),u.jsx("tbody",{children:r.map(s=>{const h=(S==null?void 0:S.dateKey)===t&&S.originalLabel===s.label,_=o.currentLabel===s.label&&t===F;return u.jsxs("tr",{children:[u.jsx("td",{children:h?u.jsx("input",{type:"text",className:"duration-input",value:N,onChange:Re,placeholder:"Activity name"}):u.jsx("span",{children:s.label})}),u.jsx("td",{children:h?u.jsx("input",{type:"text",className:"duration-input",value:w,onChange:ce,placeholder:"mm:ss or hh:mm:ss"}):u.jsx("span",{children:be(s.totalMs)})}),u.jsx("td",{className:"actions-cell",children:u.jsx("div",{className:"action-buttons",children:h?u.jsxs(u.Fragment,{children:[u.jsx("button",{type:"button",className:"icon-button icon-button--primary",onClick:Be,children:"Save"}),u.jsx("button",{type:"button",className:"icon-button",onClick:ue,children:"Cancel"})]}):u.jsxs(u.Fragment,{children:[u.jsx("button",{type:"button",className:"icon-button",disabled:_,onClick:()=>xe(t,s.label,s.totalMs),children:"Edit"}),u.jsx("button",{type:"button",className:"icon-button icon-button--danger",disabled:_,onClick:()=>Le(t,s.label),children:"Delete"})]})})})]},`${t}-${s.label}`)})})]}):null]},t)}),B?u.jsx("p",{className:"error-text",children:B}):null]})]})}Q.TimesheetDevice=jt,Object.defineProperty(Q,Symbol.toStringTag,{value:"Module"})});
