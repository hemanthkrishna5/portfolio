(function(ne,u){typeof exports=="object"&&typeof module<"u"?u(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],u):(ne=typeof globalThis<"u"?globalThis:ne||self,u(ne.TimesheetDeviceUI={},ne.React))})(this,function(ne,u){"use strict";var We={exports:{}},Se={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var st;function Et(){if(st)return Se;st=1;var c=u,f=Symbol.for("react.element"),v=Symbol.for("react.fragment"),m=Object.prototype.hasOwnProperty,E=c.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,N={key:!0,ref:!0,__self:!0,__source:!0};function y(R,w,A){var j,I={},J=null,Y=null;A!==void 0&&(J=""+A),w.key!==void 0&&(J=""+w.key),w.ref!==void 0&&(Y=w.ref);for(j in w)m.call(w,j)&&!N.hasOwnProperty(j)&&(I[j]=w[j]);if(R&&R.defaultProps)for(j in w=R.defaultProps,w)I[j]===void 0&&(I[j]=w[j]);return{$$typeof:f,type:R,key:J,ref:Y,props:I,_owner:E.current}}return Se.Fragment=v,Se.jsx=y,Se.jsxs=y,Se}var _e={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ot;function St(){return ot||(ot=1,process.env.NODE_ENV!=="production"&&function(){var c=u,f=Symbol.for("react.element"),v=Symbol.for("react.portal"),m=Symbol.for("react.fragment"),E=Symbol.for("react.strict_mode"),N=Symbol.for("react.profiler"),y=Symbol.for("react.provider"),R=Symbol.for("react.context"),w=Symbol.for("react.forward_ref"),A=Symbol.for("react.suspense"),j=Symbol.for("react.suspense_list"),I=Symbol.for("react.memo"),J=Symbol.for("react.lazy"),Y=Symbol.for("react.offscreen"),je=Symbol.iterator,Ie="@@iterator";function G(e){if(e===null||typeof e!="object")return null;var n=je&&e[je]||e[Ie];return typeof n=="function"?n:null}var Z=c.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function C(e){{for(var n=arguments.length,l=new Array(n>1?n-1:0),p=1;p<n;p++)l[p-1]=arguments[p];Qe("error",e,l)}}function Qe(e,n,l){{var p=Z.ReactDebugCurrentFrame,S=p.getStackAddendum();S!==""&&(n+="%s",l=l.concat([S]));var T=l.map(function(g){return String(g)});T.unshift("Warning: "+n),Function.prototype.apply.call(console[e],console,T)}}var fe=!1,Ze=!1,Fe=!1,xe=!1,W=!1,me;me=Symbol.for("react.module.reference");function Ne(e){return!!(typeof e=="string"||typeof e=="function"||e===m||e===N||W||e===E||e===A||e===j||xe||e===Y||fe||Ze||Fe||typeof e=="object"&&e!==null&&(e.$$typeof===J||e.$$typeof===I||e.$$typeof===y||e.$$typeof===R||e.$$typeof===w||e.$$typeof===me||e.getModuleId!==void 0))}function pe(e,n,l){var p=e.displayName;if(p)return p;var S=n.displayName||n.name||"";return S!==""?l+"("+S+")":l}function q(e){return e.displayName||"Context"}function M(e){if(e==null)return null;if(typeof e.tag=="number"&&C("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case m:return"Fragment";case v:return"Portal";case N:return"Profiler";case E:return"StrictMode";case A:return"Suspense";case j:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case R:var n=e;return q(n)+".Consumer";case y:var l=e;return q(l._context)+".Provider";case w:return pe(e,e.render,"ForwardRef");case I:var p=e.displayName||null;return p!==null?p:M(e.type)||"Memo";case J:{var S=e,T=S._payload,g=S._init;try{return M(g(T))}catch{return null}}}return null}var H=Object.assign,re=0,z,Ce,ae,he,ve,Le,De;function se(){}se.__reactDisabledLog=!0;function Ye(){{if(re===0){z=console.log,Ce=console.info,ae=console.warn,he=console.error,ve=console.group,Le=console.groupCollapsed,De=console.groupEnd;var e={configurable:!0,enumerable:!0,value:se,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}re++}}function V(){{if(re--,re===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:H({},e,{value:z}),info:H({},e,{value:Ce}),warn:H({},e,{value:ae}),error:H({},e,{value:he}),group:H({},e,{value:ve}),groupCollapsed:H({},e,{value:Le}),groupEnd:H({},e,{value:De})})}re<0&&C("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var oe=Z.ReactCurrentDispatcher,be;function K(e,n,l){{if(be===void 0)try{throw Error()}catch(S){var p=S.stack.trim().match(/\n( *(at )?)/);be=p&&p[1]||""}return`
`+be+e}}var $=!1,X;{var Oe=typeof WeakMap=="function"?WeakMap:Map;X=new Oe}function Ue(e,n){if(!e||$)return"";{var l=X.get(e);if(l!==void 0)return l}var p;$=!0;var S=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var T;T=oe.current,oe.current=null,Ye();try{if(n){var g=function(){throw Error()};if(Object.defineProperty(g.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(g,[])}catch(U){p=U}Reflect.construct(e,[],g)}else{try{g.call()}catch(U){p=U}e.call(g.prototype)}}else{try{throw Error()}catch(U){p=U}e()}}catch(U){if(U&&p&&typeof U.stack=="string"){for(var b=U.stack.split(`
`),F=p.stack.split(`
`),x=b.length-1,k=F.length-1;x>=1&&k>=0&&b[x]!==F[k];)k--;for(;x>=1&&k>=0;x--,k--)if(b[x]!==F[k]){if(x!==1||k!==1)do if(x--,k--,k<0||b[x]!==F[k]){var B=`
`+b[x].replace(" at new "," at ");return e.displayName&&B.includes("<anonymous>")&&(B=B.replace("<anonymous>",e.displayName)),typeof e=="function"&&X.set(e,B),B}while(x>=1&&k>=0);break}}}finally{$=!1,oe.current=T,V(),Error.prepareStackTrace=S}var Ee=e?e.displayName||e.name:"",ce=Ee?K(Ee):"";return typeof e=="function"&&X.set(e,ce),ce}function qe(e,n,l){return Ue(e,!1)}function $e(e){var n=e.prototype;return!!(n&&n.isReactComponent)}function ge(e,n,l){if(e==null)return"";if(typeof e=="function")return Ue(e,$e(e));if(typeof e=="string")return K(e);switch(e){case A:return K("Suspense");case j:return K("SuspenseList")}if(typeof e=="object")switch(e.$$typeof){case w:return qe(e.render);case I:return ge(e.type,n,l);case J:{var p=e,S=p._payload,T=p._init;try{return ge(T(S),n,l)}catch{}}}return""}var ie=Object.prototype.hasOwnProperty,Ve={},Be=Z.ReactDebugCurrentFrame;function ye(e){if(e){var n=e._owner,l=ge(e.type,e._source,n?n.type:null);Be.setExtraStackFrame(l)}else Be.setExtraStackFrame(null)}function et(e,n,l,p,S){{var T=Function.call.bind(ie);for(var g in e)if(T(e,g)){var b=void 0;try{if(typeof e[g]!="function"){var F=Error((p||"React class")+": "+l+" type `"+g+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[g]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw F.name="Invariant Violation",F}b=e[g](n,g,p,l,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(x){b=x}b&&!(b instanceof Error)&&(ye(S),C("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",p||"React class",l,g,typeof b),ye(null)),b instanceof Error&&!(b.message in Ve)&&(Ve[b.message]=!0,ye(S),C("Failed %s type: %s",l,b.message),ye(null))}}}var ke=Array.isArray;function Ae(e){return ke(e)}function tt(e){{var n=typeof Symbol=="function"&&Symbol.toStringTag,l=n&&e[Symbol.toStringTag]||e.constructor.name||"Object";return l}}function ee(e){try{return le(e),!1}catch{return!0}}function le(e){return""+e}function t(e){if(ee(e))return C("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",tt(e)),le(e)}var r=Z.ReactCurrentOwner,a={key:!0,ref:!0,__self:!0,__source:!0},o,i;function s(e){if(ie.call(e,"ref")){var n=Object.getOwnPropertyDescriptor(e,"ref").get;if(n&&n.isReactWarning)return!1}return e.ref!==void 0}function h(e){if(ie.call(e,"key")){var n=Object.getOwnPropertyDescriptor(e,"key").get;if(n&&n.isReactWarning)return!1}return e.key!==void 0}function _(e,n){typeof e.ref=="string"&&r.current}function L(e,n){{var l=function(){o||(o=!0,C("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",n))};l.isReactWarning=!0,Object.defineProperty(e,"key",{get:l,configurable:!0})}}function D(e,n){{var l=function(){i||(i=!0,C("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",n))};l.isReactWarning=!0,Object.defineProperty(e,"ref",{get:l,configurable:!0})}}var O=function(e,n,l,p,S,T,g){var b={$$typeof:f,type:e,key:n,ref:l,props:g,_owner:T};return b._store={},Object.defineProperty(b._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(b,"_self",{configurable:!1,enumerable:!1,writable:!1,value:p}),Object.defineProperty(b,"_source",{configurable:!1,enumerable:!1,writable:!1,value:S}),Object.freeze&&(Object.freeze(b.props),Object.freeze(b)),b};function Q(e,n,l,p,S){{var T,g={},b=null,F=null;l!==void 0&&(t(l),b=""+l),h(n)&&(t(n.key),b=""+n.key),s(n)&&(F=n.ref,_(n,S));for(T in n)ie.call(n,T)&&!a.hasOwnProperty(T)&&(g[T]=n[T]);if(e&&e.defaultProps){var x=e.defaultProps;for(T in x)g[T]===void 0&&(g[T]=x[T])}if(b||F){var k=typeof e=="function"?e.displayName||e.name||"Unknown":e;b&&L(g,k),F&&D(g,k)}return O(e,b,F,S,p,r.current,g)}}var P=Z.ReactCurrentOwner,we=Z.ReactDebugCurrentFrame;function te(e){if(e){var n=e._owner,l=ge(e.type,e._source,n?n.type:null);we.setExtraStackFrame(l)}else we.setExtraStackFrame(null)}var nt;nt=!1;function rt(e){return typeof e=="object"&&e!==null&&e.$$typeof===f}function ht(){{if(P.current){var e=M(P.current.type);if(e)return`

Check the render method of \``+e+"`."}return""}}function Pt(e){return""}var vt={};function It(e){{var n=ht();if(!n){var l=typeof e=="string"?e:e.displayName||e.name;l&&(n=`

Check the top-level render call using <`+l+">.")}return n}}function bt(e,n){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var l=It(n);if(vt[l])return;vt[l]=!0;var p="";e&&e._owner&&e._owner!==P.current&&(p=" It was passed a child from "+M(e._owner.type)+"."),te(e),C('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',l,p),te(null)}}function gt(e,n){{if(typeof e!="object")return;if(Ae(e))for(var l=0;l<e.length;l++){var p=e[l];rt(p)&&bt(p,n)}else if(rt(e))e._store&&(e._store.validated=!0);else if(e){var S=G(e);if(typeof S=="function"&&S!==e.entries)for(var T=S.call(e),g;!(g=T.next()).done;)rt(g.value)&&bt(g.value,n)}}}function Ft(e){{var n=e.type;if(n==null||typeof n=="string")return;var l;if(typeof n=="function")l=n.propTypes;else if(typeof n=="object"&&(n.$$typeof===w||n.$$typeof===I))l=n.propTypes;else return;if(l){var p=M(n);et(l,e.props,"prop",p,e)}else if(n.PropTypes!==void 0&&!nt){nt=!0;var S=M(n);C("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",S||"Unknown")}typeof n.getDefaultProps=="function"&&!n.getDefaultProps.isReactClassApproved&&C("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function Yt(e){{for(var n=Object.keys(e.props),l=0;l<n.length;l++){var p=n[l];if(p!=="children"&&p!=="key"){te(e),C("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",p),te(null);break}}e.ref!==null&&(te(e),C("Invalid attribute `ref` supplied to `React.Fragment`."),te(null))}}var yt={};function wt(e,n,l,p,S,T){{var g=Ne(e);if(!g){var b="";(e===void 0||typeof e=="object"&&e!==null&&Object.keys(e).length===0)&&(b+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var F=Pt();F?b+=F:b+=ht();var x;e===null?x="null":Ae(e)?x="array":e!==void 0&&e.$$typeof===f?(x="<"+(M(e.type)||"Unknown")+" />",b=" Did you accidentally export a JSX literal instead of a component?"):x=typeof e,C("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",x,b)}var k=Q(e,n,l,S,T);if(k==null)return k;if(g){var B=n.children;if(B!==void 0)if(p)if(Ae(B)){for(var Ee=0;Ee<B.length;Ee++)gt(B[Ee],e);Object.freeze&&Object.freeze(B)}else C("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else gt(B,e)}if(ie.call(n,"key")){var ce=M(e),U=Object.keys(n).filter(function(Gt){return Gt!=="key"}),at=U.length>0?"{key: someKey, "+U.join(": ..., ")+": ...}":"{key: someKey}";if(!yt[ce+at]){var Jt=U.length>0?"{"+U.join(": ..., ")+": ...}":"{}";C(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,at,ce,Jt,ce),yt[ce+at]=!0}}return e===m?Yt(k):Ft(k),k}}function Ut(e,n,l){return wt(e,n,l,!0)}function Vt(e,n,l){return wt(e,n,l,!1)}var Bt=Vt,Wt=Ut;_e.Fragment=m,_e.jsx=Bt,_e.jsxs=Wt}()),_e}process.env.NODE_ENV==="production"?We.exports=Et():We.exports=St();var d=We.exports;const ue={},it="/api/imu/latest",_t="/api/imu/history",Me=12,Tt=1e3,Je="dodec-labels",lt=["dodeca-labels"],ct="dodec-activity-log",Rt="Side",jt=24*60*60*1e3,Ge="DODEC_LABEL_UPDATE",ut="DODEC_LABELS_REQUEST",dt=(()=>{const c=ue==null?void 0:ue.VITE_DEVICE_LABELS_URL;if(c&&c.length>0)return c;try{const f=new URL(it,"https://placeholder.local");return`${f.origin==="https://placeholder.local"?"":`${f.protocol}//${f.host}`}/api/labels`}catch{return"/api/labels"}})(),He=(ue==null?void 0:ue.VITE_DEVICE_ACTIVITY_LOG_URL)??"/api/activity-log",xt=5*60*1e3,ft=c=>{const f={};if(!c||typeof c!="object")return f;for(const[v,m]of Object.entries(c)){if(typeof v!="string"||v.length===0||!m||typeof m!="object")continue;const E={};for(const[N,y]of Object.entries(m)){if(typeof N!="string"||N.length===0)continue;let R=0,w=null;if(typeof y=="number")R=Number.isFinite(y)&&y>0?Math.floor(y):0;else if(y&&typeof y=="object"){const A=y.totalMs,j=y.side;typeof A=="number"&&Number.isFinite(A)&&A>0&&(R=Math.floor(A)),typeof j=="number"&&Number.isFinite(j)&&(w=Math.floor(j))}(R>0||w!==null)&&(E[N]={totalMs:R,side:w})}Object.keys(E).length>0&&(f[v]=E)}return f},Nt=Array.from({length:Me},(c,f)=>f+1),ze=()=>{const c={};for(const f of Nt)c[f]="";return c},Ct=()=>{if(typeof window>"u")return ze();const c=v=>{try{const m=window.localStorage.getItem(v);if(!m)return null;const E=JSON.parse(m),N=ze();for(const[y,R]of Object.entries(E)){const w=Number(y);Number.isFinite(w)&&w>=1&&w<=Me&&(N[w]=String(R??""))}return N}catch(m){return console.warn("Unable to read stored labels",m),null}},f=c(Je);if(f)return f;for(const v of lt){const m=c(v);if(m){try{window.localStorage.setItem(Je,JSON.stringify(m))}catch{}return m}}return ze()},mt=()=>({currentLabel:null,startTime:null,lastTimestamp:null,lastSide:null}),Ke=(c,f)=>{var m;const v=(m=c[f])==null?void 0:m.trim();return v&&v.length>0?v:`${Rt} ${f}`},Lt=c=>{const f=[c.received_at,c.imu_timestamp_iso];for(const v of f)if(v){const m=Date.parse(v);if(!Number.isNaN(m))return m}if(c.imu_timestamp_text){const v=c.imu_timestamp_text.replace(" ","T"),m=Date.parse(v);if(!Number.isNaN(m))return m}return Date.now()},Dt=c=>{if(!c)return null;const f=Date.parse(c);return Number.isNaN(f)?null:f},de=c=>{const f=new Date(c),v=f.getFullYear(),m=String(f.getMonth()+1).padStart(2,"0"),E=String(f.getDate()).padStart(2,"0");return`${v}-${m}-${E}`},Te=c=>{const[f,v,m]=c.split("-").map(Number);return new Date(f,v-1,m)},Pe=c=>{const f=Te(c),v=new Date(f.getFullYear(),f.getMonth(),f.getDate()).getTime(),m=v+jt;return{start:v,end:m}},pt=c=>{const f=Te(c);return new Intl.DateTimeFormat(void 0,{dateStyle:"medium"}).format(f)},Ot=c=>c?c.replace("T"," ").replace(/\+.*$/,""):"Waiting for data?",Re=c=>{if(!Number.isFinite(c)||c<=0)return"00:00";const f=Math.floor(c/1e3),v=Math.floor(f/3600),m=Math.floor(f%3600/60),E=f%60;return v>0?`${String(v).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(E).padStart(2,"0")}`:`${String(m).padStart(2,"0")}:${String(E).padStart(2,"0")}`},kt=c=>Re(c),At=c=>{const f=c.trim();if(!f)return NaN;const v=f.split(":");if(v.length>1){if(v.length>3)return NaN;const E=v.map(w=>Number(w));if(E.some(w=>Number.isNaN(w)||w<0))return NaN;let N=0,y=0,R=0;return E.length===3?[N,y,R]=E:[y,R]=E,Math.max(0,N*3600+y*60+R)*1e3}const m=Number(f);return Number.isNaN(m)||m<0?NaN:m*60*1e3},Xe=c=>c.includes('"')||c.includes(",")||c.includes(`
`)?`"${c.replace(/"/g,'""')}"`:c;function Mt(){const[c,f]=u.useState(null),[v,m]=u.useState(null),[E,N]=u.useState(()=>{if(typeof window>"u")return{};try{const t=window.localStorage.getItem(ct);return t?ft(JSON.parse(t)):{}}catch(t){return console.warn("Unable to read stored activity log",t),{}}}),[y,R]=u.useState(null),[w,A]=u.useState(""),[j,I]=u.useState(""),[J,Y]=u.useState(null),[je,Ie]=u.useState(()=>[de(Date.now())]),[G,Z]=u.useState("week"),[C,Qe]=u.useState(de(Date.now())),[fe,Ze]=u.useState(de(Date.now())),[Fe,xe]=u.useState(null),[W,me]=u.useState(()=>Ct()),Ne=u.useRef(W),pe=u.useRef(!1),q=u.useRef({}),M=u.useRef(mt()),[H,re]=u.useState(!1),[z,Ce]=u.useState(!1),[ae,he]=u.useState(!1),ve=u.useRef(!1),Le=u.useCallback((t,r,a,o)=>{o<=a||N(i=>{const s={...i};let h=a;for(;h<o;){const _=de(h),{end:L}=Pe(_),D=Math.min(o,L),O=Math.max(0,D-h);if(O>0){const Q={...s[_]??{}},P=Q[t],we=((P==null?void 0:P.totalMs)??0)+O,te=r??(P==null?void 0:P.side)??null;Q[t]={totalMs:we,side:te},s[_]=Q}h=D}return s})},[]),De=u.useCallback(()=>{M.current=mt(),N(()=>({}))},[]),se=u.useCallback(t=>{const r=typeof t.side=="number"?t.side:null;if(!r)return;const a=Ke(Ne.current,r),o=Lt(t),i=t.segment_started_at?Dt(t.segment_started_at):null,s=M.current;if(s.currentLabel===null||s.startTime===null){s.currentLabel=a,s.startTime=i??o,s.lastTimestamp=o,s.lastSide=r;return}if(a===s.currentLabel){i!==null&&(s.startTime===null||i<s.startTime)&&(s.startTime=i),s.lastTimestamp=o,s.lastSide=r;return}const h=s.startTime,_=o;_>h&&Le(s.currentLabel,s.lastSide,h,_),s.currentLabel=a,s.startTime=i??o,s.lastTimestamp=o,s.lastSide=r},[Le]);u.useEffect(()=>{if(Ne.current=W,typeof window<"u"){const r=JSON.stringify(W);window.localStorage.setItem(Je,r);for(const a of lt)window.localStorage.setItem(a,r);!pe.current&&window.parent&&window.parent!==window&&window.parent.postMessage({type:Ge,labels:W},"*")}pe.current=!1;const t=M.current;t.lastSide!==null&&(t.currentLabel=Ke(W,t.lastSide))},[W]),u.useEffect(()=>{typeof window<"u"&&window.localStorage.setItem(ct,JSON.stringify(E))},[E]),u.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(He,{cache:"no-store"});if(!a.ok)throw new Error(`Activity log request failed with status ${a.status}`);const o=await a.json();if(t)return;o&&typeof o=="object"&&o.entries&&(ve.current=!0,N(ft(o.entries))),Ce(!0),he(!1)}catch(a){t||(console.warn("[activity-log] failed to load activity log from server",a),Ce(!0))}})(),()=>{t=!0}},[]),u.useEffect(()=>()=>{if(!(typeof window>"u"))for(const t of Object.keys(q.current)){const r=q.current[Number(t)];typeof r=="number"&&window.clearTimeout(r)}},[]),u.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(dt,{cache:"no-store"});if(!a.ok)throw new Error(`Failed to load labels (status ${a.status})`);const o=await a.json();if(t||!o||typeof o.labels!="object"||o.labels===null)return;pe.current=!0,me(i=>{const s={...i};let h=!1;for(const[_,L]of Object.entries(o.labels)){const D=Number(_);if(!Number.isFinite(D)||D<1||D>Me)continue;const O=typeof L=="string"?L:"";s[D]!==O&&(s[D]=O,h=!0)}return h?s:i})}catch(a){console.error("[timesheet-app] failed to load labels from server",a)}})(),()=>{t=!0}},[]),u.useEffect(()=>{if(typeof window>"u")return;const t=r=>{const a=r==null?void 0:r.data;if(!(!a||typeof a!="object"))if(a.type===Ge&&a.labels&&typeof a.labels=="object"){pe.current=!0;const o=a.labels;me(i=>{const s={...i};for(const[h,_]of Object.entries(o)){const L=Number(h);!Number.isFinite(L)||L<1||L>Me||(s[L]=typeof _=="string"?_:"")}return{...s}})}else a.type===ut&&window.parent&&window.parent!==window&&window.parent.postMessage({type:Ge,labels:Ne.current},r.origin||"*")};return window.addEventListener("message",t),window.parent&&window.parent!==window&&window.parent.postMessage({type:ut},"*"),()=>{window.removeEventListener("message",t)}},[]),u.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(`${_t}?limit=5000`,{cache:"no-store"});if(!a.ok)throw new Error(`History request failed with status ${a.status}`);const o=await a.json();if(t)return;De();let i=null;for(const s of o){if(t)break;se(s),i=s}i&&f({side:typeof i.side=="number"?i.side:null,imu_timestamp_text:i.imu_timestamp_text??null,imu_timestamp_iso:i.imu_timestamp_iso??null,received_at:i.received_at??null,confidence:i.confidence??null}),m(null)}catch(a){t||m(a instanceof Error?a.message:"Unknown error while loading history")}finally{t||re(!0)}})(),()=>{t=!0}},[se,De]),u.useEffect(()=>{if(!H)return;let t=!0;const r=async()=>{try{const o=await fetch(it,{cache:"no-store"});if(!o.ok)throw new Error(`Request failed with status ${o.status}`);const i=await o.json();if(!t)return;se(i),f({side:typeof i.side=="number"?i.side:null,imu_timestamp_text:i.imu_timestamp_text??null,imu_timestamp_iso:i.imu_timestamp_iso??null,received_at:i.received_at??null,confidence:i.confidence??null}),m(null)}catch(o){t&&m(o instanceof Error?o.message:"Unknown error")}};r();const a=window.setInterval(r,Tt);return()=>{t=!1,window.clearInterval(a)}},[se,H]);const Ye=M.current,V=Ye.lastTimestamp?de(Ye.lastTimestamp):de(Date.now());u.useEffect(()=>{Ie(t=>t.includes(V)?t:[...t,V])},[V]);const oe=u.useCallback(async(t,r)=>{try{const a=await fetch(`${dt.replace(/\/$/,"")}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:r})});if(!a.ok)throw new Error(`Failed to persist label (status ${a.status})`)}catch(a){console.error(`[timesheet-app] failed to persist label for side ${t}`,a)}},[]),be=u.useCallback((t,r)=>{const a=r.trim();if(typeof window>"u"){oe(t,a);return}const o=q.current[t];typeof o=="number"&&window.clearTimeout(o),q.current[t]=window.setTimeout(()=>{q.current[t]=null,oe(t,a)},400)},[oe]);u.useCallback(t=>r=>{const a=r.target.value;me(o=>({...o,[t]:a})),be(t,a)},[be]);const K=(t,r)=>{const a=M.current;if(!a.currentLabel||a.currentLabel!==r||a.startTime===null||a.lastTimestamp===null)return 0;const{start:o,end:i}=Pe(t),s=Math.max(o,a.startTime),h=Math.min(i,a.lastTimestamp);return h>s?h-s:0},$=u.useCallback(t=>{const r=E[t]??{},a=Object.entries(r).map(([i,s])=>({label:i,totalMs:s.totalMs,side:s.side??null})),o=M.current;if(o.currentLabel&&o.startTime!==null&&o.lastTimestamp!==null){const i=K(t,o.currentLabel);if(i>0){const s=a.find(_=>_.label===o.currentLabel),h=o.lastSide;s?(s.totalMs+=i,s.side===null&&(s.side=h)):a.push({label:o.currentLabel,totalMs:i,side:h??null})}}return a.sort((i,s)=>s.totalMs-i.totalMs)},[E,c]),X=u.useMemo(()=>{const t=new Set(Object.keys(E));return t.add(V),Array.from(t).sort((r,a)=>r===a?0:r>a?-1:1)},[E,V]),Oe=u.useMemo(()=>X.map(t=>{const r=$(t);if(r.length===0)return null;const a=r.reduce((o,i)=>o+i.totalMs,0);return{dateKey:t,rows:r,totalMs:a}}).filter(Boolean),[X,$]),Ue=u.useCallback((t,r,a)=>{if(M.current.currentLabel===r&&t===V){Y("Stop the current activity before editing it.");return}R({dateKey:t,originalLabel:r}),A(kt(a)),I(r),Y(null)},[V]),qe=u.useCallback(t=>{A(t.target.value)},[]),$e=u.useCallback(t=>{I(t.target.value)},[]),ge=u.useCallback(()=>{R(null),A(""),I(""),Y(null)},[]),ie=u.useCallback(()=>{if(!y)return;const{dateKey:t,originalLabel:r}=y,a=At(w);if(!Number.isFinite(a)){Y("Please enter duration as mm:ss, hh:mm:ss, or minutes.");return}const o=j.trim();if(o.length===0){Y("Activity name cannot be empty.");return}const i=K(t,r);if(a<i){Y(`Duration cannot be less than the active segment (${Re(i)}).`);return}const s=Math.max(0,a-i);N(h=>{const _={...h},L={..._[t]??{}},D=L[r];if(D&&delete L[r],s>0){const O=L[o],Q=((O==null?void 0:O.totalMs)??0)+s,P=o===r?(D==null?void 0:D.side)??(O==null?void 0:O.side)??null:(O==null?void 0:O.side)??(D==null?void 0:D.side)??null;L[o]={totalMs:Q,side:P}}return Object.keys(L).length===0?delete _[t]:_[t]=L,_}),R(null),A(""),I(""),Y(null)},[y,w,j,K]),Ve=u.useCallback((t,r)=>{if(K(t,r)>0){Y("Stop the current activity before deleting it.");return}N(o=>{const i=o[t];if(!i||!(r in i))return o;const s={...o},h={...i};return delete h[r],Object.keys(h).length===0?delete s[t]:s[t]=h,s}),y&&y.dateKey===t&&y.originalLabel===r&&(R(null),A(""),I("")),Y(null)},[y]),Be=u.useCallback(t=>{Ie(r=>r.includes(t)?r.filter(a=>a!==t):[...r,t])},[]),ye=()=>{if(G==="week"){const{start:i,end:s}=Pe(V),h=new Date(i);return h.setDate(h.getDate()-6),{start:new Date(h.getFullYear(),h.getMonth(),h.getDate()).getTime(),end:s}}if(G==="month"){const i=Te(V),s=new Date(i.getFullYear(),i.getMonth(),1).getTime(),h=new Date(i.getFullYear(),i.getMonth()+1,1).getTime();return{start:s,end:h}}const t=Te(C),r=Te(fe);if(Number.isNaN(t.getTime())||Number.isNaN(r.getTime())||t>r)return null;const a=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime(),o=new Date(r.getFullYear(),r.getMonth(),r.getDate()+1).getTime();return{start:a,end:o}},et=u.useCallback(()=>{const t=ye();if(!t){xe("Please provide a valid date range before downloading.");return}const r=[];for(const _ of X){const{start:L,end:D}=Pe(_);if(D<=t.start||L>=t.end)continue;const O=$(_);if(O.length===0)continue;const Q=pt(_);for(const P of O){const we=P.side!==null?`Side ${P.side}`:"";r.push(`${Xe(Q)},${Xe(P.label)},${Xe(we)},${Re(P.totalMs)}`)}}if(r.length===0){xe("No activity recorded in the selected range.");return}const a=["Date,Activity,Side,Duration",...r].join(`
`),o=new Blob([a],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i;const h=G==="custom"?"custom":G;s.download=`activity-log-${h}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),xe(null)},[$,G,X,C,fe]),ke=(c==null?void 0:c.side)??null,Ae=u.useMemo(()=>ke===null?null:Ke(W,ke),[ke,W]),tt=(c==null?void 0:c.imu_timestamp_text)??(c==null?void 0:c.imu_timestamp_iso)??(c==null?void 0:c.received_at)??null,ee=u.useCallback(async(t=!1)=>{if(!(!z||!ae&&!t))try{const r=await fetch(He,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({entries:E})});if(!r.ok)throw new Error(`Activity log sync failed with status ${r.status}`);he(!1)}catch(r){console.warn("[activity-log] failed to sync activity log",r)}},[E,z,ae]);u.useEffect(()=>{if(z){if(ve.current){ve.current=!1;return}he(!0),ee(!0)}},[E,z,ee]),u.useEffect(()=>{if(!z||typeof window>"u")return;const t=window.setInterval(()=>{ee()},xt);return()=>window.clearInterval(t)},[z,ee]),u.useEffect(()=>{if(typeof window>"u")return;const t=()=>{if(ae){if(navigator.sendBeacon)try{const r=new Blob([JSON.stringify({entries:E})],{type:"application/json"});navigator.sendBeacon(He,r);return}catch(r){console.warn("[activity-log] sendBeacon flush failed",r)}ee(!0)}};return window.addEventListener("pagehide",t),window.addEventListener("beforeunload",t),()=>{window.removeEventListener("pagehide",t),window.removeEventListener("beforeunload",t)}},[E,ae,ee]);const le=u.useCallback(()=>{var o,i,s;if(typeof window>"u"||window.parent===window)return;const t=window.document,r=((o=t.documentElement)==null?void 0:o.scrollHeight)||((i=t.body)==null?void 0:i.scrollHeight)||window.innerHeight,a=Math.max(320,Math.min(Math.ceil(r),4e3));(s=window.parent)==null||s.postMessage({type:"EMBED_HEIGHT",height:a},"*")},[]);return u.useEffect(()=>{le()},[le,Oe.length,je,W,y,G]),u.useEffect(()=>{if(typeof window>"u")return;const t=()=>le();window.addEventListener("load",t),window.addEventListener("resize",t);let r=null;return typeof ResizeObserver<"u"&&(r=new ResizeObserver(t),r.observe(window.document.documentElement)),()=>{window.removeEventListener("load",t),window.removeEventListener("resize",t),r==null||r.disconnect()}},[le]),d.jsxs("div",{className:"app-shell",children:[d.jsxs("header",{className:"app-header",children:[d.jsx("h1",{children:"Do-Decahedron Orientation"}),d.jsxs("p",{className:"status-line",children:[d.jsx("span",{className:"status-label",children:"Latest IMU update:"}),d.jsx("span",{className:"status-value",children:Ot(tt)})]}),d.jsxs("p",{className:"status-line",children:[d.jsx("span",{className:"status-label",children:"Current activity:"}),d.jsx("span",{className:"status-value",children:Ae??"Waiting for data?"})]}),v?d.jsxs("p",{className:"error-text",children:["Error: ",v]}):null]}),d.jsxs("section",{className:"activity-summary","aria-live":"polite",children:[d.jsx("h2",{children:"Activity Log"}),d.jsxs("div",{className:"range-controls",children:[d.jsxs("label",{className:"range-option",children:["Range",d.jsxs("select",{className:"range-select",value:G,onChange:t=>Z(t.target.value),children:[d.jsx("option",{value:"week",children:"This week"}),d.jsx("option",{value:"month",children:"This month"}),d.jsx("option",{value:"custom",children:"Custom"})]})]}),G==="custom"?d.jsxs(d.Fragment,{children:[d.jsxs("label",{className:"range-option",children:["From",d.jsx("input",{type:"date",className:"date-input",value:C,max:fe,onChange:t=>Qe(t.target.value)})]}),d.jsxs("label",{className:"range-option",children:["To",d.jsx("input",{type:"date",className:"date-input",value:fe,min:C,onChange:t=>Ze(t.target.value)})]})]}):null,d.jsx("button",{type:"button",className:"download-button",onClick:et,children:"Download CSV"})]}),Fe?d.jsx("p",{className:"error-text",children:Fe}):null,Oe.length===0?d.jsx("p",{className:"placeholder-text",children:"No activity recorded yet."}):Oe.map(({dateKey:t,rows:r,totalMs:a})=>{const o=je.includes(t),i=M.current;return d.jsxs("div",{className:"date-group",children:[d.jsxs("button",{type:"button",className:`date-header${o?" date-header--expanded":""}`,onClick:()=>Be(t),children:[d.jsxs("div",{className:"date-header__title",children:[d.jsx("span",{className:"date-label",children:pt(t)}),d.jsxs("span",{className:"date-summary",children:[r.length," activit",r.length===1?"y":"ies"," - ",Re(a)]})]}),d.jsx("span",{className:"date-header__icon",children:o?"−":"+"})]}),o?d.jsxs("table",{className:"activity-table",children:[d.jsx("thead",{children:d.jsxs("tr",{children:[d.jsx("th",{scope:"col",children:"Activity"}),d.jsx("th",{scope:"col",className:"side-heading",children:"Side"}),d.jsx("th",{scope:"col",children:"Total Duration"}),d.jsx("th",{scope:"col",className:"actions-heading",children:"Actions"})]})}),d.jsx("tbody",{children:r.map(s=>{const h=(y==null?void 0:y.dateKey)===t&&y.originalLabel===s.label,_=i.currentLabel===s.label&&t===V;return d.jsxs("tr",{children:[d.jsx("td",{children:h?d.jsx("input",{type:"text",className:"duration-input",value:j,onChange:$e,placeholder:"Activity name"}):d.jsx("span",{children:s.label})}),d.jsx("td",{className:"side-cell",children:d.jsx("span",{children:s.side!==null?`Side ${s.side}`:"—"})}),d.jsx("td",{children:h?d.jsx("input",{type:"text",className:"duration-input",value:w,onChange:qe,placeholder:"mm:ss or hh:mm:ss"}):d.jsx("span",{children:Re(s.totalMs)})}),d.jsx("td",{className:"actions-cell",children:d.jsx("div",{className:"action-buttons",children:h?d.jsxs(d.Fragment,{children:[d.jsx("button",{type:"button",className:"icon-button icon-button--primary",onClick:ie,children:"Save"}),d.jsx("button",{type:"button",className:"icon-button",onClick:ge,children:"Cancel"})]}):d.jsxs(d.Fragment,{children:[d.jsx("button",{type:"button",className:"icon-button",disabled:_,onClick:()=>Ue(t,s.label,s.totalMs),children:"Edit"}),d.jsx("button",{type:"button",className:"icon-button icon-button--danger",disabled:_,onClick:()=>Ve(t,s.label),children:"Delete"})]})})})]},`${t}-${s.label}`)})})]}):null]},t)}),J?d.jsx("p",{className:"error-text",children:J}):null]})]})}ne.TimesheetDevice=Mt,Object.defineProperty(ne,Symbol.toStringTag,{value:"Module"})});
