(function(oe,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],l):(oe=typeof globalThis<"u"?globalThis:oe||self,l(oe.TimesheetDeviceUI={},oe.React))})(this,function(oe,l){"use strict";var rt={exports:{}},Ne={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Et;function Nt(){if(Et)return Ne;Et=1;var u=l,d=Symbol.for("react.element"),g=Symbol.for("react.fragment"),h=Object.prototype.hasOwnProperty,R=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,P={key:!0,ref:!0,__self:!0,__source:!0};function _(E,v,A){var j,W={},Y=null,le=null;A!==void 0&&(Y=""+A),v.key!==void 0&&(Y=""+v.key),v.ref!==void 0&&(le=v.ref);for(j in v)h.call(v,j)&&!P.hasOwnProperty(j)&&(W[j]=v[j]);if(E&&E.defaultProps)for(j in v=E.defaultProps,v)W[j]===void 0&&(W[j]=v[j]);return{$$typeof:d,type:E,key:Y,ref:le,props:W,_owner:R.current}}return Ne.Fragment=g,Ne.jsx=_,Ne.jsxs=_,Ne}var ke={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var St;function kt(){return St||(St=1,process.env.NODE_ENV!=="production"&&function(){var u=l,d=Symbol.for("react.element"),g=Symbol.for("react.portal"),h=Symbol.for("react.fragment"),R=Symbol.for("react.strict_mode"),P=Symbol.for("react.profiler"),_=Symbol.for("react.provider"),E=Symbol.for("react.context"),v=Symbol.for("react.forward_ref"),A=Symbol.for("react.suspense"),j=Symbol.for("react.suspense_list"),W=Symbol.for("react.memo"),Y=Symbol.for("react.lazy"),le=Symbol.for("react.offscreen"),H=Symbol.iterator,Je="@@iterator";function Pe(e){if(e===null||typeof e!="object")return null;var r=H&&e[H]||e[Je];return typeof r=="function"?r:null}var M=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function D(e){{for(var r=arguments.length,o=new Array(r>1?r-1:0),p=1;p<r;p++)o[p-1]=arguments[p];ye("error",e,o)}}function ye(e,r,o){{var p=M.ReactDebugCurrentFrame,w=p.getStackAddendum();w!==""&&(r+="%s",o=o.concat([w]));var T=o.map(function(b){return String(b)});T.unshift("Warning: "+r),Function.prototype.apply.call(console[e],console,T)}}var ut=!1,ve=!1,ft=!1,Ge=!1,Ae=!1,$;$=Symbol.for("react.module.reference");function Me(e){return!!(typeof e=="string"||typeof e=="function"||e===h||e===P||Ae||e===R||e===A||e===j||Ge||e===le||ut||ve||ft||typeof e=="object"&&e!==null&&(e.$$typeof===Y||e.$$typeof===W||e.$$typeof===_||e.$$typeof===E||e.$$typeof===v||e.$$typeof===$||e.getModuleId!==void 0))}function q(e,r,o){var p=e.displayName;if(p)return p;var w=r.displayName||r.name||"";return w!==""?o+"("+w+")":o}function Ie(e){return e.displayName||"Context"}function G(e){if(e==null)return null;if(typeof e.tag=="number"&&D("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case h:return"Fragment";case g:return"Portal";case P:return"Profiler";case R:return"StrictMode";case A:return"Suspense";case j:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case E:var r=e;return Ie(r)+".Consumer";case _:var o=e;return Ie(o._context)+".Provider";case v:return q(e,e.render,"ForwardRef");case W:var p=e.displayName||null;return p!==null?p:G(e.type)||"Memo";case Y:{var w=e,T=w._payload,b=w._init;try{return G(b(T))}catch{return null}}}return null}var L=Object.assign,I=0,be,we,ce,ee,F,z,Fe;function ze(){}ze.__reactDisabledLog=!0;function Ke(){{if(I===0){be=console.log,we=console.info,ce=console.warn,ee=console.error,F=console.group,z=console.groupCollapsed,Fe=console.groupEnd;var e={configurable:!0,enumerable:!0,value:ze,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}I++}}function Ee(){{if(I--,I===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:L({},e,{value:be}),info:L({},e,{value:we}),warn:L({},e,{value:ce}),error:L({},e,{value:ee}),group:L({},e,{value:F}),groupCollapsed:L({},e,{value:z}),groupEnd:L({},e,{value:Fe})})}I<0&&D("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var Xe=M.ReactCurrentDispatcher,Se;function J(e,r,o){{if(Se===void 0)try{throw Error()}catch(w){var p=w.stack.trim().match(/\n( *(at )?)/);Se=p&&p[1]||""}return`
`+Se+e}}var Q=!1,te;{var dt=typeof WeakMap=="function"?WeakMap:Map;te=new dt}function ue(e,r){if(!e||Q)return"";{var o=te.get(e);if(o!==void 0)return o}var p;Q=!0;var w=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var T;T=Xe.current,Xe.current=null,Ke();try{if(r){var b=function(){throw Error()};if(Object.defineProperty(b.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(b,[])}catch(B){p=B}Reflect.construct(e,[],b)}else{try{b.call()}catch(B){p=B}e.call(b.prototype)}}else{try{throw Error()}catch(B){p=B}e()}}catch(B){if(B&&p&&typeof B.stack=="string"){for(var y=B.stack.split(`
`),U=p.stack.split(`
`),x=y.length-1,k=U.length-1;x>=1&&k>=0&&y[x]!==U[k];)k--;for(;x>=1&&k>=0;x--,k--)if(y[x]!==U[k]){if(x!==1||k!==1)do if(x--,k--,k<0||y[x]!==U[k]){var X=`
`+y[x].replace(" at new "," at ");return e.displayName&&X.includes("<anonymous>")&&(X=X.replace("<anonymous>",e.displayName)),typeof e=="function"&&te.set(e,X),X}while(x>=1&&k>=0);break}}}finally{Q=!1,Xe.current=T,Ee(),Error.prepareStackTrace=w}var Ce=e?e.displayName||e.name:"",he=Ce?J(Ce):"";return typeof e=="function"&&te.set(e,he),he}function Qe(e,r,o){return ue(e,!1)}function fe(e){var r=e.prototype;return!!(r&&r.isReactComponent)}function V(e,r,o){if(e==null)return"";if(typeof e=="function")return ue(e,fe(e));if(typeof e=="string")return J(e);switch(e){case A:return J("Suspense");case j:return J("SuspenseList")}if(typeof e=="object")switch(e.$$typeof){case v:return Qe(e.render);case W:return V(e.type,r,o);case Y:{var p=e,w=p._payload,T=p._init;try{return V(T(w),r,o)}catch{}}}return""}var ne=Object.prototype.hasOwnProperty,Z={},O=M.ReactDebugCurrentFrame;function de(e){if(e){var r=e._owner,o=V(e.type,e._source,r?r.type:null);O.setExtraStackFrame(o)}else O.setExtraStackFrame(null)}function Ze(e,r,o,p,w){{var T=Function.call.bind(ne);for(var b in e)if(T(e,b)){var y=void 0;try{if(typeof e[b]!="function"){var U=Error((p||"React class")+": "+o+" type `"+b+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[b]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw U.name="Invariant Violation",U}y=e[b](r,b,p,o,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(x){y=x}y&&!(y instanceof Error)&&(de(w),D("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",p||"React class",o,b,typeof y),de(null)),y instanceof Error&&!(y.message in Z)&&(Z[y.message]=!0,de(w),D("Failed %s type: %s",o,y.message),de(null))}}}var qe=Array.isArray;function re(e){return qe(e)}function $e(e){{var r=typeof Symbol=="function"&&Symbol.toStringTag,o=r&&e[Symbol.toStringTag]||e.constructor.name||"Object";return o}}function K(e){try{return Re(e),!1}catch{return!0}}function Re(e){return""+e}function Ue(e){if(K(e))return D("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",$e(e)),Re(e)}var ae=M.ReactCurrentOwner,Te={key:!0,ref:!0,__self:!0,__source:!0},me,_e;function mt(e){if(ne.call(e,"ref")){var r=Object.getOwnPropertyDescriptor(e,"ref").get;if(r&&r.isReactWarning)return!1}return e.ref!==void 0}function pt(e){if(ne.call(e,"key")){var r=Object.getOwnPropertyDescriptor(e,"key").get;if(r&&r.isReactWarning)return!1}return e.key!==void 0}function ht(e,r){typeof e.ref=="string"&&ae.current}function gt(e,r){{var o=function(){me||(me=!0,D("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",r))};o.isReactWarning=!0,Object.defineProperty(e,"key",{get:o,configurable:!0})}}function je(e,r){{var o=function(){_e||(_e=!0,D("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",r))};o.isReactWarning=!0,Object.defineProperty(e,"ref",{get:o,configurable:!0})}}var yt=function(e,r,o,p,w,T,b){var y={$$typeof:d,type:e,key:r,ref:o,props:b,_owner:T};return y._store={},Object.defineProperty(y._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(y,"_self",{configurable:!1,enumerable:!1,writable:!1,value:p}),Object.defineProperty(y,"_source",{configurable:!1,enumerable:!1,writable:!1,value:w}),Object.freeze&&(Object.freeze(y.props),Object.freeze(y)),y};function vt(e,r,o,p,w){{var T,b={},y=null,U=null;o!==void 0&&(Ue(o),y=""+o),pt(r)&&(Ue(r.key),y=""+r.key),mt(r)&&(U=r.ref,ht(r,w));for(T in r)ne.call(r,T)&&!Te.hasOwnProperty(T)&&(b[T]=r[T]);if(e&&e.defaultProps){var x=e.defaultProps;for(T in x)b[T]===void 0&&(b[T]=x[T])}if(y||U){var k=typeof e=="function"?e.displayName||e.name||"Unknown":e;y&&gt(b,k),U&&je(b,k)}return yt(e,y,U,w,p,ae.current,b)}}var Ye=M.ReactCurrentOwner,et=M.ReactDebugCurrentFrame;function se(e){if(e){var r=e._owner,o=V(e.type,e._source,r?r.type:null);et.setExtraStackFrame(o)}else et.setExtraStackFrame(null)}var pe;pe=!1;function Ve(e){return typeof e=="object"&&e!==null&&e.$$typeof===d}function tt(){{if(Ye.current){var e=G(Ye.current.type);if(e)return`

Check the render method of \``+e+"`."}return""}}function bt(e){return""}var nt={};function xe(e){{var r=tt();if(!r){var o=typeof e=="string"?e:e.displayName||e.name;o&&(r=`

Check the top-level render call using <`+o+">.")}return r}}function t(e,r){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var o=xe(r);if(nt[o])return;nt[o]=!0;var p="";e&&e._owner&&e._owner!==Ye.current&&(p=" It was passed a child from "+G(e._owner.type)+"."),se(e),D('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',o,p),se(null)}}function n(e,r){{if(typeof e!="object")return;if(re(e))for(var o=0;o<e.length;o++){var p=e[o];Ve(p)&&t(p,r)}else if(Ve(e))e._store&&(e._store.validated=!0);else if(e){var w=Pe(e);if(typeof w=="function"&&w!==e.entries)for(var T=w.call(e),b;!(b=T.next()).done;)Ve(b.value)&&t(b.value,r)}}}function a(e){{var r=e.type;if(r==null||typeof r=="string")return;var o;if(typeof r=="function")o=r.propTypes;else if(typeof r=="object"&&(r.$$typeof===v||r.$$typeof===W))o=r.propTypes;else return;if(o){var p=G(r);Ze(o,e.props,"prop",p,e)}else if(r.PropTypes!==void 0&&!pe){pe=!0;var w=G(r);D("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",w||"Unknown")}typeof r.getDefaultProps=="function"&&!r.getDefaultProps.isReactClassApproved&&D("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function s(e){{for(var r=Object.keys(e.props),o=0;o<r.length;o++){var p=r[o];if(p!=="children"&&p!=="key"){se(e),D("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",p),se(null);break}}e.ref!==null&&(se(e),D("Invalid attribute `ref` supplied to `React.Fragment`."),se(null))}}var c={};function i(e,r,o,p,w,T){{var b=Me(e);if(!b){var y="";(e===void 0||typeof e=="object"&&e!==null&&Object.keys(e).length===0)&&(y+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var U=bt();U?y+=U:y+=tt();var x;e===null?x="null":re(e)?x="array":e!==void 0&&e.$$typeof===d?(x="<"+(G(e.type)||"Unknown")+" />",y=" Did you accidentally export a JSX literal instead of a component?"):x=typeof e,D("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",x,y)}var k=vt(e,r,o,w,T);if(k==null)return k;if(b){var X=r.children;if(X!==void 0)if(p)if(re(X)){for(var Ce=0;Ce<X.length;Ce++)n(X[Ce],e);Object.freeze&&Object.freeze(X)}else D("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else n(X,e)}if(ne.call(r,"key")){var he=G(e),B=Object.keys(r).filter(function(Ht){return Ht!=="key"}),wt=B.length>0?"{key: someKey, "+B.join(": ..., ")+": ...}":"{key: someKey}";if(!c[he+wt]){var Wt=B.length>0?"{"+B.join(": ..., ")+": ...}":"{}";D(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,wt,he,Wt,he),c[he+wt]=!0}}return e===h?s(k):a(k),k}}function m(e,r,o){return i(e,r,o,!0)}function S(e,r,o){return i(e,r,o,!1)}var C=S,N=m;ke.Fragment=h,ke.jsx=C,ke.jsxs=N}()),ke}process.env.NODE_ENV==="production"?rt.exports=Nt():rt.exports=kt();var f=rt.exports;const ge={},Rt="/api/imu/latest",Dt="/api/imu/history",Be=12,Lt=1e3,at="dodec-labels",Tt=["dodeca-labels"],_t="dodec-activity-log",Ot="Side",Pt=24*60*60*1e3,st="DODEC_LABEL_UPDATE",jt="DODEC_LABELS_REQUEST",xt=(()=>{const u=ge==null?void 0:ge.VITE_DEVICE_LABELS_URL;if(u&&u.length>0)return u;try{const d=new URL(Rt,"https://placeholder.local");return`${d.origin==="https://placeholder.local"?"":`${d.protocol}//${d.host}`}/api/labels`}catch{return"/api/labels"}})(),De=(ge==null?void 0:ge.VITE_DEVICE_ACTIVITY_LOG_URL)??"/api/activity-log",We=u=>{const d={};if(!u||typeof u!="object")return d;for(const[g,h]of Object.entries(u)){if(typeof g!="string"||g.length===0||!h||typeof h!="object")continue;const R={};for(const[P,_]of Object.entries(h)){if(typeof P!="string"||P.length===0)continue;let E=0,v=null;if(typeof _=="number")E=Number.isFinite(_)&&_>0?Math.floor(_):0;else if(_&&typeof _=="object"){const A=_.totalMs,j=_.side;typeof A=="number"&&Number.isFinite(A)&&A>0&&(E=Math.floor(A)),typeof j=="number"&&Number.isFinite(j)&&(v=Math.floor(j))}(E>0||v!==null)&&(R[P]={totalMs:E,side:v})}Object.keys(R).length>0&&(d[g]=R)}return d},At=Array.from({length:Be},(u,d)=>d+1),ot=()=>{const u={};for(const d of At)u[d]="";return u},Mt=()=>{if(typeof window>"u")return ot();const u=g=>{try{const h=window.localStorage.getItem(g);if(!h)return null;const R=JSON.parse(h),P=ot();for(const[_,E]of Object.entries(R)){const v=Number(_);Number.isFinite(v)&&v>=1&&v<=Be&&(P[v]=String(E??""))}return P}catch(h){return console.warn("Unable to read stored labels",h),null}},d=u(at);if(d)return d;for(const g of Tt){const h=u(g);if(h){try{window.localStorage.setItem(at,JSON.stringify(h))}catch{}return h}}return ot()},it=()=>({currentLabel:null,startTime:null,lastTimestamp:null,lastSide:null}),lt=(u,d)=>{var h;const g=(h=u[d])==null?void 0:h.trim();return g&&g.length>0?g:`${Ot} ${d}`},It=u=>{const d=[u.received_at,u.imu_timestamp_iso];for(const g of d)if(g){const h=Date.parse(g);if(!Number.isNaN(h))return h}if(u.imu_timestamp_text){const g=u.imu_timestamp_text.replace(" ","T"),h=Date.parse(g);if(!Number.isNaN(h))return h}return Date.now()},Ft=u=>{if(!u)return null;const d=Date.parse(u);return Number.isNaN(d)?null:d},ie=u=>{const d=new Date(u),g=d.getFullYear(),h=String(d.getMonth()+1).padStart(2,"0"),R=String(d.getDate()).padStart(2,"0");return`${g}-${h}-${R}`},Le=u=>{const[d,g,h]=u.split("-").map(Number);return new Date(d,g-1,h)},He=u=>{const d=Le(u),g=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(),h=g+Pt;return{start:g,end:h}},Ct=u=>{const d=Le(u);return new Intl.DateTimeFormat(void 0,{dateStyle:"medium"}).format(d)},Ut=u=>u?u.replace("T"," ").replace(/\+.*$/,""):"Waiting for data?",Oe=u=>{if(!Number.isFinite(u)||u<=0)return"00:00";const d=Math.floor(u/1e3),g=Math.floor(d/3600),h=Math.floor(d%3600/60),R=d%60;return g>0?`${String(g).padStart(2,"0")}:${String(h).padStart(2,"0")}:${String(R).padStart(2,"0")}`:`${String(h).padStart(2,"0")}:${String(R).padStart(2,"0")}`},Yt=u=>Oe(u),Vt=u=>{const d=u.trim();if(!d)return NaN;const g=d.split(":");if(g.length>1){if(g.length>3)return NaN;const R=g.map(v=>Number(v));if(R.some(v=>Number.isNaN(v)||v<0))return NaN;let P=0,_=0,E=0;return R.length===3?[P,_,E]=R:[_,E]=R,Math.max(0,P*3600+_*60+E)*1e3}const h=Number(d);return Number.isNaN(h)||h<0?NaN:h*60*1e3},ct=u=>u.includes('"')||u.includes(",")||u.includes(`
`)?`"${u.replace(/"/g,'""')}"`:u;function Bt(){const[u,d]=l.useState(null),[g,h]=l.useState(null),[R,P]=l.useState(()=>{if(typeof window>"u")return{};try{const t=window.localStorage.getItem(_t);return t?We(JSON.parse(t)):{}}catch(t){return console.warn("Unable to read stored activity log",t),{}}}),_=l.useRef(R),[E,v]=l.useState(null),[A,j]=l.useState(""),[W,Y]=l.useState(""),[le,H]=l.useState(null),[Je,Pe]=l.useState(()=>[ie(Date.now())]),[M,D]=l.useState("week"),[ye,ut]=l.useState(ie(Date.now())),[ve,ft]=l.useState(ie(Date.now())),[Ge,Ae]=l.useState(null),[$,Me]=l.useState(!1),[q,Ie]=l.useState(!1),[G,L]=l.useState(null),[I,be]=l.useState(()=>Mt()),we=l.useRef(I),ce=l.useRef(!1),ee=l.useRef({}),F=l.useRef(null),z=l.useRef(it()),[Fe,ze]=l.useState(!1),[Ke,Ee]=l.useState(!1),[Xe,Se]=l.useState(!1),J=l.useRef(!1),Q=l.useRef(!1),te=l.useRef(0),dt=l.useRef(!1),ue=l.useRef(null),[Qe,fe]=l.useState(!1),V=l.useRef(!1),ne=l.useCallback(()=>{J.current||(J.current=!0,Se(!0))},[]),Z=l.useCallback(()=>{J.current&&(J.current=!1,Se(!1))},[]),O=l.useCallback((t,n)=>{P(a=>{const s=t(a);return _.current=s,((n==null?void 0:n.markDirty)??!0)&&!V.current&&s!==a&&(Ke||(Q.current=!0),ne()),s})},[Ke,ne]),de=l.useCallback(async t=>{const n=(t==null?void 0:t.allowSkip)??!0,a=te.current+1;te.current=a;const s=await fetch(De,{cache:"no-store"});if(!s.ok)throw new Error(`Activity log request failed with status ${s.status}`);const c=await s.json(),i=typeof(c==null?void 0:c.historyCutoffIso)=="string"&&c.historyCutoffIso.length>0?c.historyCutoffIso:null;if(ue.current=i,a!==te.current)return!1;if(c&&typeof c=="object"&&c.entries){if(n&&Q.current)return console.warn("[activity-log] skipped applying remote log because local edits occurred first"),Q.current=!1,Ee(!0),J.current||Z(),!1;dt.current=!0,O(()=>We(c.entries),{markDirty:!1})}return Q.current=!1,Ee(!0),J.current||Z(),!0},[O,Z]);l.useEffect(()=>{_.current=R},[R]);const Ze=l.useCallback((t,n,a,s)=>{s<=a||V.current||O(c=>{const i={...c};let m=a;for(;m<s;){const S=ie(m),{end:C}=He(S),N=Math.min(s,C),e=Math.max(0,N-m);if(e>0){const r={...i[S]??{}},o=r[t],p=((o==null?void 0:o.totalMs)??0)+e,w=n??(o==null?void 0:o.side)??null;r[t]={totalMs:p,side:w},i[S]=r}m=N}return i})},[O,V]),qe=l.useCallback(()=>{z.current=it(),!V.current&&O(()=>({}))},[O,V]),re=l.useCallback(t=>{const n=typeof t.side=="number"?t.side:null;if(!n)return;const a=lt(we.current,n),s=It(t),c=t.segment_started_at?Ft(t.segment_started_at):null,i=z.current;if(i.currentLabel===null||i.startTime===null){i.currentLabel=a,i.startTime=c??s,i.lastTimestamp=s,i.lastSide=n;return}if(a===i.currentLabel){c!==null&&(i.startTime===null||c<i.startTime)&&(i.startTime=c),i.lastTimestamp=s,i.lastSide=n;return}const m=i.startTime,S=s;S>m&&Ze(i.currentLabel,i.lastSide,m,S),i.currentLabel=a,i.startTime=c??s,i.lastTimestamp=s,i.lastSide=n},[Ze]);l.useEffect(()=>{if(we.current=I,typeof window<"u"){const n=JSON.stringify(I);window.localStorage.setItem(at,n);for(const a of Tt)window.localStorage.setItem(a,n);!ce.current&&window.parent&&window.parent!==window&&window.parent.postMessage({type:st,labels:I},"*")}ce.current=!1;const t=z.current;t.lastSide!==null&&(t.currentLabel=lt(I,t.lastSide))},[I]),l.useEffect(()=>{typeof window<"u"&&window.localStorage.setItem(_t,JSON.stringify(R))},[R]),l.useEffect(()=>{let t=!1;return(async()=>{try{await de({allowSkip:!0})}catch(a){t||(console.warn("[activity-log] failed to load activity log from server",a),Q.current=!1,Ee(!0))}finally{t||fe(!0)}})(),()=>{t=!0}},[de]),l.useEffect(()=>()=>{if(!(typeof window>"u")){for(const t of Object.keys(ee.current)){const n=ee.current[Number(t)];typeof n=="number"&&window.clearTimeout(n)}F.current!==null&&window.clearTimeout(F.current)}},[]),l.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(xt,{cache:"no-store"});if(!a.ok)throw new Error(`Failed to load labels (status ${a.status})`);const s=await a.json();if(t||!s||typeof s.labels!="object"||s.labels===null)return;ce.current=!0,be(c=>{const i={...c};let m=!1;for(const[S,C]of Object.entries(s.labels)){const N=Number(S);if(!Number.isFinite(N)||N<1||N>Be)continue;const e=typeof C=="string"?C:"";i[N]!==e&&(i[N]=e,m=!0)}return m?i:c})}catch(a){console.error("[timesheet-app] failed to load labels from server",a)}})(),()=>{t=!0}},[]),l.useEffect(()=>{if(typeof window>"u")return;const t=n=>{const a=n==null?void 0:n.data;if(!(!a||typeof a!="object"))if(a.type===st&&a.labels&&typeof a.labels=="object"){ce.current=!0;const s=a.labels;be(c=>{const i={...c};for(const[m,S]of Object.entries(s)){const C=Number(m);!Number.isFinite(C)||C<1||C>Be||(i[C]=typeof S=="string"?S:"")}return{...i}})}else a.type===jt&&window.parent&&window.parent!==window&&window.parent.postMessage({type:st,labels:we.current},n.origin||"*")};return window.addEventListener("message",t),window.parent&&window.parent!==window&&window.parent.postMessage({type:jt},"*"),()=>{window.removeEventListener("message",t)}},[]),l.useEffect(()=>{if(!Qe)return;let t=!1;return(async()=>{V.current=!0;try{const a=new URLSearchParams({limit:"5000"}),s=ue.current;s&&a.set("since",s);const c=await fetch(`${Dt}?${a.toString()}`,{cache:"no-store"});if(!c.ok)throw new Error(`History request failed with status ${c.status}`);const i=await c.json();if(t)return;qe();let m=null;for(const S of i){if(t)break;re(S),m=S}m&&d({side:typeof m.side=="number"?m.side:null,imu_timestamp_text:m.imu_timestamp_text??null,imu_timestamp_iso:m.imu_timestamp_iso??null,received_at:m.received_at??null,confidence:m.confidence??null}),h(null)}catch(a){t||h(a instanceof Error?a.message:"Unknown error while loading history")}finally{V.current=!1,t||ze(!0)}})(),()=>{t=!0}},[re,Qe,qe]),l.useEffect(()=>{if(!Fe)return;let t=!0;const n=async()=>{try{const s=await fetch(Rt,{cache:"no-store"});if(!s.ok)throw new Error(`Request failed with status ${s.status}`);const c=await s.json();if(!t)return;re(c),d({side:typeof c.side=="number"?c.side:null,imu_timestamp_text:c.imu_timestamp_text??null,imu_timestamp_iso:c.imu_timestamp_iso??null,received_at:c.received_at??null,confidence:c.confidence??null}),h(null)}catch(s){t&&h(s instanceof Error?s.message:"Unknown error")}};n();const a=window.setInterval(n,Lt);return()=>{t=!1,window.clearInterval(a)}},[re,Fe]);const $e=z.current,K=$e.lastTimestamp?ie($e.lastTimestamp):ie(Date.now());l.useEffect(()=>{Pe(t=>t.includes(K)?t:[...t,K])},[K]);const Re=l.useCallback(async(t,n)=>{try{const a=await fetch(`${xt.replace(/\/$/,"")}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:n})});if(!a.ok)throw new Error(`Failed to persist label (status ${a.status})`)}catch(a){console.error(`[timesheet-app] failed to persist label for side ${t}`,a)}},[]),Ue=l.useCallback((t,n)=>{const a=n.trim();if(typeof window>"u"){Re(t,a);return}const s=ee.current[t];typeof s=="number"&&window.clearTimeout(s),ee.current[t]=window.setTimeout(()=>{ee.current[t]=null,Re(t,a)},400)},[Re]);l.useCallback(t=>n=>{const a=n.target.value;be(s=>({...s,[t]:a})),Ue(t,a)},[Ue]);const ae=(t,n)=>{const a=z.current;if(!a.currentLabel||a.currentLabel!==n||a.startTime===null||a.lastTimestamp===null)return 0;const{start:s,end:c}=He(t),i=Math.max(s,a.startTime),m=Math.min(c,a.lastTimestamp);return m>i?m-i:0},Te=l.useCallback(t=>{const n=R[t]??{},a=Object.entries(n).map(([c,i])=>({label:c,totalMs:i.totalMs,side:i.side??null})),s=z.current;if(s.currentLabel&&s.startTime!==null&&s.lastTimestamp!==null){const c=ae(t,s.currentLabel);if(c>0){const i=a.find(S=>S.label===s.currentLabel),m=s.lastSide;i?(i.totalMs+=c,i.side===null&&(i.side=m)):a.push({label:s.currentLabel,totalMs:c,side:m??null})}}return a.sort((c,i)=>i.totalMs-c.totalMs)},[R,u]),me=l.useMemo(()=>{const t=new Set(Object.keys(R));return t.add(K),Array.from(t).sort((n,a)=>n===a?0:n>a?-1:1)},[R,K]),_e=l.useMemo(()=>me.map(t=>{const n=Te(t);if(n.length===0)return null;const a=n.reduce((s,c)=>s+c.totalMs,0);return{dateKey:t,rows:n,totalMs:a}}).filter(Boolean),[me,Te]),mt=l.useCallback((t,n,a)=>{if(z.current.currentLabel===n&&t===K){H("Stop the current activity before editing it.");return}v({dateKey:t,originalLabel:n}),j(Yt(a)),Y(n),H(null)},[K]),pt=l.useCallback(t=>{j(t.target.value)},[]),ht=l.useCallback(t=>{Y(t.target.value)},[]),gt=l.useCallback(()=>{v(null),j(""),Y(""),H(null)},[]),je=l.useCallback(()=>{if(!E)return!0;const{dateKey:t,originalLabel:n}=E,a=Vt(A);if(!Number.isFinite(a))return H("Please enter duration as mm:ss, hh:mm:ss, or minutes."),!1;const s=W.trim();if(s.length===0)return H("Activity name cannot be empty."),!1;const c=ae(t,n);if(a<c)return H(`Duration cannot be less than the active segment (${Oe(c)}).`),!1;const i=Math.max(0,a-c);return O(m=>{const S={...m},C={...S[t]??{}},N=C[n];if(N&&delete C[n],i>0){const e=C[s],r=((e==null?void 0:e.totalMs)??0)+i,o=s===n?(N==null?void 0:N.side)??(e==null?void 0:e.side)??null:(e==null?void 0:e.side)??(N==null?void 0:N.side)??null;C[s]={totalMs:r,side:o}}return Object.keys(C).length===0?delete S[t]:S[t]=C,S}),v(null),j(""),Y(""),H(null),!0},[O,E,A,W,ae]),yt=l.useCallback(()=>{je()},[je]),vt=l.useCallback((t,n)=>{if(ae(t,n)>0){H("Stop the current activity before deleting it.");return}O(s=>{const c=s[t];if(!c||!(n in c))return s;const i={...s},m={...c};return delete m[n],Object.keys(m).length===0?delete i[t]:i[t]=m,i}),E&&E.dateKey===t&&E.originalLabel===n&&(v(null),j(""),Y("")),H(null)},[O,E,ae]),Ye=l.useCallback(t=>{Pe(n=>n.includes(t)?n.filter(a=>a!==t):[...n,t])},[]),et=()=>{if(M==="week"){const{start:c,end:i}=He(K),m=new Date(c);return m.setDate(m.getDate()-6),{start:new Date(m.getFullYear(),m.getMonth(),m.getDate()).getTime(),end:i}}if(M==="month"){const c=Le(K),i=new Date(c.getFullYear(),c.getMonth(),1).getTime(),m=new Date(c.getFullYear(),c.getMonth()+1,1).getTime();return{start:i,end:m}}const t=Le(ye),n=Le(ve);if(Number.isNaN(t.getTime())||Number.isNaN(n.getTime())||t>n)return null;const a=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime(),s=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1).getTime();return{start:a,end:s}},se=l.useCallback(()=>{const t=et();if(!t){Ae("Please provide a valid date range before downloading.");return}const n=[];for(const S of me){const{start:C,end:N}=He(S);if(N<=t.start||C>=t.end)continue;const e=Te(S);if(e.length===0)continue;const r=Ct(S);for(const o of e){const p=o.side!==null?`Side ${o.side}`:"";n.push(`${ct(r)},${ct(o.label)},${ct(p)},${Oe(o.totalMs)}`)}}if(n.length===0){Ae("No activity recorded in the selected range.");return}const a=["Date,Activity,Side,Duration",...n].join(`
`),s=new Blob([a],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(s),i=document.createElement("a");i.href=c;const m=M==="custom"?"custom":M;i.download=`activity-log-${m}.csv`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(c),Ae(null)},[Te,M,me,ye,ve]),pe=(u==null?void 0:u.side)??null,Ve=l.useMemo(()=>pe===null?null:lt(I,pe),[pe,I]),tt=(u==null?void 0:u.imu_timestamp_text)??(u==null?void 0:u.imu_timestamp_iso)??(u==null?void 0:u.received_at)??null,bt=l.useCallback(async()=>{if($||q)return;if(Me(!0),L(null),typeof window<"u"&&F.current!==null&&(window.clearTimeout(F.current),F.current=null),!je()){L({type:"error",message:"Please finish editing or fix validation errors before saving."}),Me(!1);return}const n=_.current;try{const a=await fetch(De,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({entries:n})});if(!a.ok)throw new Error(`Activity log sync failed with status ${a.status}`);try{const s=await a.json();if(s&&typeof s=="object"){s.entries&&O(()=>We(s.entries),{markDirty:!1});const c=typeof s.historyCutoffIso=="string"&&s.historyCutoffIso.length>0?s.historyCutoffIso:null;ue.current=c,fe(!0)}}catch{}Z(),L({type:"success",message:"Activity log saved."}),typeof window<"u"&&(F.current=window.setTimeout(()=>{L(null),F.current=null},4e3))}catch(a){console.warn("[activity-log] failed to save activity log",a),L({type:"error",message:"Unable to save activity log. Please try again."})}finally{Me(!1)}},[O,je,Z,q,$,fe]),nt=l.useCallback(async()=>{if(!q&&!(typeof window<"u"&&!window.confirm("This will delete all activity log entries. Continue?"))){typeof window<"u"&&F.current!==null&&(window.clearTimeout(F.current),F.current=null),L(null),Ie(!0);try{const t=await fetch(De,{method:"DELETE"});if(!t.ok)throw new Error(`Activity log clear failed with status ${t.status}`);let n=null;try{n=await t.json()}catch{n=null}V.current=!0,z.current=it(),O(()=>n&&n.entries&&typeof n.entries=="object"?We(n.entries):{},{markDirty:!1});const a=n&&typeof n.historyCutoffIso=="string"&&n.historyCutoffIso.length>0?n.historyCutoffIso:new Date().toISOString();ue.current=a,fe(!0),Pe([ie(Date.now())]),v(null),j(""),Y(""),H(null),Z(),Q.current=!1,J.current=!1,Ee(!0),L({type:"success",message:"Activity log cleared."}),typeof window<"u"&&(F.current=window.setTimeout(()=>{L(null),F.current=null},4e3))}catch(t){console.warn("[activity-log] failed to clear activity log",t),L({type:"error",message:"Unable to clear activity log. Please try again."})}finally{V.current=!1,Ie(!1)}}},[O,Z,q,fe]);l.useEffect(()=>{if(typeof window>"u")return;const t=()=>{if(J.current){if(navigator.sendBeacon)try{const n=new Blob([JSON.stringify({entries:_.current})],{type:"application/json"});navigator.sendBeacon(De,n);return}catch(n){console.warn("[activity-log] sendBeacon flush failed",n)}fetch(De,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({entries:_.current}),keepalive:!0})}};return window.addEventListener("pagehide",t),window.addEventListener("beforeunload",t),()=>{window.removeEventListener("pagehide",t),window.removeEventListener("beforeunload",t)}},[]);const xe=l.useCallback(()=>{var s,c,i;if(typeof window>"u"||window.parent===window)return;const t=window.document,n=((s=t.documentElement)==null?void 0:s.scrollHeight)||((c=t.body)==null?void 0:c.scrollHeight)||window.innerHeight,a=Math.max(320,Math.min(Math.ceil(n),4e3));(i=window.parent)==null||i.postMessage({type:"EMBED_HEIGHT",height:a},"*")},[]);return l.useEffect(()=>{xe()},[xe,_e.length,Je,I,E,M]),l.useEffect(()=>{if(typeof window>"u")return;const t=()=>xe();window.addEventListener("load",t),window.addEventListener("resize",t);let n=null;return typeof ResizeObserver<"u"&&(n=new ResizeObserver(t),n.observe(window.document.documentElement)),()=>{window.removeEventListener("load",t),window.removeEventListener("resize",t),n==null||n.disconnect()}},[xe]),f.jsxs("div",{className:"app-shell",children:[f.jsxs("header",{className:"app-header",children:[f.jsx("h1",{children:"Do-Decahedron Orientation"}),f.jsxs("p",{className:"status-line",children:[f.jsx("span",{className:"status-label",children:"Latest IMU update:"}),f.jsx("span",{className:"status-value",children:Ut(tt)})]}),f.jsxs("p",{className:"status-line",children:[f.jsx("span",{className:"status-label",children:"Current activity:"}),f.jsx("span",{className:"status-value",children:Ve??"Waiting for data?"})]}),g?f.jsxs("p",{className:"error-text",children:["Error: ",g]}):null]}),f.jsxs("section",{className:"activity-summary","aria-live":"polite",children:[f.jsx("h2",{children:"Activity Log"}),f.jsxs("div",{className:"range-controls",children:[f.jsxs("label",{className:"range-option",children:["Range",f.jsxs("select",{className:"range-select",value:M,onChange:t=>D(t.target.value),children:[f.jsx("option",{value:"week",children:"This week"}),f.jsx("option",{value:"month",children:"This month"}),f.jsx("option",{value:"custom",children:"Custom"})]})]}),M==="custom"?f.jsxs(f.Fragment,{children:[f.jsxs("label",{className:"range-option",children:["From",f.jsx("input",{type:"date",className:"date-input",value:ye,max:ve,onChange:t=>ut(t.target.value)})]}),f.jsxs("label",{className:"range-option",children:["To",f.jsx("input",{type:"date",className:"date-input",value:ve,min:ye,onChange:t=>ft(t.target.value)})]})]}):null,f.jsx("button",{type:"button",className:"download-button push-right",onClick:se,children:"Download CSV"}),f.jsx("button",{type:"button",className:"download-button danger-button",onClick:nt,disabled:q||$,children:q?"Clearing...":"Clear All"}),f.jsx("button",{type:"button",className:"download-button save-button",onClick:bt,disabled:$||q,children:$?"Saving...":"Save Changes"})]}),Ge?f.jsx("p",{className:"error-text",children:Ge}):null,G?f.jsx("p",{className:G.type==="error"?"error-text":"success-text",children:G.message}):null,_e.length===0?f.jsx("p",{className:"placeholder-text",children:"No activity recorded yet."}):_e.map(({dateKey:t,rows:n,totalMs:a})=>{const s=Je.includes(t),c=z.current;return f.jsxs("div",{className:"date-group",children:[f.jsxs("button",{type:"button",className:`date-header${s?" date-header--expanded":""}`,onClick:()=>Ye(t),children:[f.jsxs("div",{className:"date-header__title",children:[f.jsx("span",{className:"date-label",children:Ct(t)}),f.jsxs("span",{className:"date-summary",children:[n.length," activit",n.length===1?"y":"ies"," - ",Oe(a)]})]}),f.jsx("span",{className:"date-header__icon",children:s?"−":"+"})]}),s?f.jsxs("table",{className:"activity-table",children:[f.jsx("thead",{children:f.jsxs("tr",{children:[f.jsx("th",{scope:"col",children:"Activity"}),f.jsx("th",{scope:"col",className:"side-heading",children:"Side"}),f.jsx("th",{scope:"col",children:"Total Duration"}),f.jsx("th",{scope:"col",className:"actions-heading",children:"Actions"})]})}),f.jsx("tbody",{children:n.map(i=>{const m=(E==null?void 0:E.dateKey)===t&&E.originalLabel===i.label,S=c.currentLabel===i.label&&t===K;return f.jsxs("tr",{children:[f.jsx("td",{children:m?f.jsx("input",{type:"text",className:"duration-input",value:W,onChange:ht,placeholder:"Activity name"}):f.jsx("span",{children:i.label})}),f.jsx("td",{className:"side-cell",children:f.jsx("span",{children:i.side!==null?`Side ${i.side}`:"—"})}),f.jsx("td",{children:m?f.jsx("input",{type:"text",className:"duration-input",value:A,onChange:pt,placeholder:"mm:ss or hh:mm:ss"}):f.jsx("span",{children:Oe(i.totalMs)})}),f.jsx("td",{className:"actions-cell",children:f.jsx("div",{className:"action-buttons",children:m?f.jsxs(f.Fragment,{children:[f.jsx("button",{type:"button",className:"icon-button icon-button--primary",onClick:yt,children:"Save"}),f.jsx("button",{type:"button",className:"icon-button",onClick:gt,children:"Cancel"})]}):f.jsxs(f.Fragment,{children:[f.jsx("button",{type:"button",className:"icon-button",disabled:S,onClick:()=>mt(t,i.label,i.totalMs),children:"Edit"}),f.jsx("button",{type:"button",className:"icon-button icon-button--danger",disabled:S,onClick:()=>vt(t,i.label),children:"Delete"})]})})})]},`${t}-${i.label}`)})})]}):null]},t)}),le?f.jsx("p",{className:"error-text",children:le}):null]})]})}oe.TimesheetDevice=Bt,Object.defineProperty(oe,Symbol.toStringTag,{value:"Module"})});
