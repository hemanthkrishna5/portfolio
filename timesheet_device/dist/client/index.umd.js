(function(ue,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],o):(ue=typeof globalThis<"u"?globalThis:ue||self,o(ue.TimesheetDeviceUI={},ue.React))})(this,function(ue,o){"use strict";var $e={exports:{}},je={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var gt;function Ct(){if(gt)return je;gt=1;var u=o,d=Symbol.for("react.element"),v=Symbol.for("react.fragment"),m=Object.prototype.hasOwnProperty,w=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,P={key:!0,ref:!0,__self:!0,__source:!0};function R(E,b,A){var x,U={},V=null,fe=null;A!==void 0&&(V=""+A),b.key!==void 0&&(V=""+b.key),b.ref!==void 0&&(fe=b.ref);for(x in b)m.call(b,x)&&!P.hasOwnProperty(x)&&(U[x]=b[x]);if(E&&E.defaultProps)for(x in b=E.defaultProps,b)U[x]===void 0&&(U[x]=b[x]);return{$$typeof:d,type:E,key:V,ref:fe,props:U,_owner:w.current}}return je.Fragment=v,je.jsx=R,je.jsxs=R,je}var Ce={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var bt;function Nt(){return bt||(bt=1,process.env.NODE_ENV!=="production"&&function(){var u=o,d=Symbol.for("react.element"),v=Symbol.for("react.portal"),m=Symbol.for("react.fragment"),w=Symbol.for("react.strict_mode"),P=Symbol.for("react.profiler"),R=Symbol.for("react.provider"),E=Symbol.for("react.context"),b=Symbol.for("react.forward_ref"),A=Symbol.for("react.suspense"),x=Symbol.for("react.suspense_list"),U=Symbol.for("react.memo"),V=Symbol.for("react.lazy"),fe=Symbol.for("react.offscreen"),G=Symbol.iterator,Ve="@@iterator";function Be(e){if(e===null||typeof e!="object")return null;var r=G&&e[G]||e[Ve];return typeof r=="function"?r:null}var M=u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function O(e){{for(var r=arguments.length,c=new Array(r>1?r-1:0),p=1;p<r;p++)c[p-1]=arguments[p];Se("error",e,c)}}function Se(e,r,c){{var p=M.ReactDebugCurrentFrame,S=p.getStackAddendum();S!==""&&(r+="%s",c=c.concat([S]));var T=c.map(function(y){return String(y)});T.unshift("Warning: "+r),Function.prototype.apply.call(console[e],console,T)}}var ot=!1,_e=!1,it=!1,We=!1,Le=!1,de;de=Symbol.for("react.module.reference");function De(e){return!!(typeof e=="string"||typeof e=="function"||e===m||e===P||Le||e===w||e===A||e===x||We||e===fe||ot||_e||it||typeof e=="object"&&e!==null&&(e.$$typeof===V||e.$$typeof===U||e.$$typeof===R||e.$$typeof===E||e.$$typeof===b||e.$$typeof===de||e.getModuleId!==void 0))}function Oe(e,r,c){var p=e.displayName;if(p)return p;var S=r.displayName||r.name||"";return S!==""?c+"("+S+")":c}function ne(e){return e.displayName||"Context"}function D(e){if(e==null)return null;if(typeof e.tag=="number"&&O("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case m:return"Fragment";case v:return"Portal";case P:return"Profiler";case w:return"StrictMode";case A:return"Suspense";case x:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case E:var r=e;return ne(r)+".Consumer";case R:var c=e;return ne(c._context)+".Provider";case b:return Oe(e,e.render,"ForwardRef");case U:var p=e.displayName||null;return p!==null?p:D(e.type)||"Memo";case V:{var S=e,T=S._payload,y=S._init;try{return D(y(T))}catch{return null}}}return null}var K=Object.assign,re=0,me,se,q,X,Pe,Je,Q;function Te(){}Te.__reactDisabledLog=!0;function jt(){{if(re===0){me=console.log,se=console.info,q=console.warn,X=console.error,Pe=console.group,Je=console.groupCollapsed,Q=console.groupEnd;var e={configurable:!0,enumerable:!0,value:Te,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}re++}}function Ge(){{if(re--,re===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:K({},e,{value:me}),info:K({},e,{value:se}),warn:K({},e,{value:q}),error:K({},e,{value:X}),group:K({},e,{value:Pe}),groupCollapsed:K({},e,{value:Je}),groupEnd:K({},e,{value:Q})})}re<0&&O("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var B=M.ReactCurrentDispatcher,$;function oe(e,r,c){{if($===void 0)try{throw Error()}catch(S){var p=S.stack.trim().match(/\n( *(at )?)/);$=p&&p[1]||""}return`
`+$+e}}var pe=!1,ae;{var he=typeof WeakMap=="function"?WeakMap:Map;ae=new he}function W(e,r){if(!e||pe)return"";{var c=ae.get(e);if(c!==void 0)return c}var p;pe=!0;var S=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var T;T=B.current,B.current=null,jt();try{if(r){var y=function(){throw Error()};if(Object.defineProperty(y.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(y,[])}catch(Y){p=Y}Reflect.construct(e,[],y)}else{try{y.call()}catch(Y){p=Y}e.call(y.prototype)}}else{try{throw Error()}catch(Y){p=Y}e()}}catch(Y){if(Y&&p&&typeof Y.stack=="string"){for(var g=Y.stack.split(`
`),F=p.stack.split(`
`),C=g.length-1,L=F.length-1;C>=1&&L>=0&&g[C]!==F[L];)L--;for(;C>=1&&L>=0;C--,L--)if(g[C]!==F[L]){if(C!==1||L!==1)do if(C--,L--,L<0||g[C]!==F[L]){var z=`
`+g[C].replace(" at new "," at ");return e.displayName&&z.includes("<anonymous>")&&(z=z.replace("<anonymous>",e.displayName)),typeof e=="function"&&ae.set(e,z),z}while(C>=1&&L>=0);break}}}finally{pe=!1,B.current=T,Ge(),Error.prepareStackTrace=S}var xe=e?e.displayName||e.name:"",ye=xe?oe(xe):"";return typeof e=="function"&&ae.set(e,ye),ye}function ie(e,r,c){return W(e,!1)}function He(e){var r=e.prototype;return!!(r&&r.isReactComponent)}function ve(e,r,c){if(e==null)return"";if(typeof e=="function")return W(e,He(e));if(typeof e=="string")return oe(e);switch(e){case A:return oe("Suspense");case x:return oe("SuspenseList")}if(typeof e=="object")switch(e.$$typeof){case b:return ie(e.render);case U:return ve(e.type,r,c);case V:{var p=e,S=p._payload,T=p._init;try{return ve(T(S),r,c)}catch{}}}return""}var ee=Object.prototype.hasOwnProperty,Ae={},J=M.ReactDebugCurrentFrame;function le(e){if(e){var r=e._owner,c=ve(e.type,e._source,r?r.type:null);J.setExtraStackFrame(c)}else J.setExtraStackFrame(null)}function ze(e,r,c,p,S){{var T=Function.call.bind(ee);for(var y in e)if(T(e,y)){var g=void 0;try{if(typeof e[y]!="function"){var F=Error((p||"React class")+": "+c+" type `"+y+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[y]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw F.name="Invariant Violation",F}g=e[y](r,y,p,c,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(C){g=C}g&&!(g instanceof Error)&&(le(S),O("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",p||"React class",c,y,typeof g),le(null)),g instanceof Error&&!(g.message in Ae)&&(Ae[g.message]=!0,le(S),O("Failed %s type: %s",c,g.message),le(null))}}}var ge=Array.isArray;function ce(e){return ge(e)}function Re(e){{var r=typeof Symbol=="function"&&Symbol.toStringTag,c=r&&e[Symbol.toStringTag]||e.constructor.name||"Object";return c}}function Me(e){try{return Ke(e),!1}catch{return!0}}function Ke(e){return""+e}function Xe(e){if(Me(e))return O("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",Re(e)),Ke(e)}var Qe=M.ReactCurrentOwner,lt={key:!0,ref:!0,__self:!0,__source:!0},be,Ze;function ct(e){if(ee.call(e,"ref")){var r=Object.getOwnPropertyDescriptor(e,"ref").get;if(r&&r.isReactWarning)return!1}return e.ref!==void 0}function ut(e){if(ee.call(e,"key")){var r=Object.getOwnPropertyDescriptor(e,"key").get;if(r&&r.isReactWarning)return!1}return e.key!==void 0}function ft(e,r){typeof e.ref=="string"&&Qe.current}function dt(e,r){{var c=function(){be||(be=!0,O("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",r))};c.isReactWarning=!0,Object.defineProperty(e,"key",{get:c,configurable:!0})}}function Ie(e,r){{var c=function(){Ze||(Ze=!0,O("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",r))};c.isReactWarning=!0,Object.defineProperty(e,"ref",{get:c,configurable:!0})}}var mt=function(e,r,c,p,S,T,y){var g={$$typeof:d,type:e,key:r,ref:c,props:y,_owner:T};return g._store={},Object.defineProperty(g._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(g,"_self",{configurable:!1,enumerable:!1,writable:!1,value:p}),Object.defineProperty(g,"_source",{configurable:!1,enumerable:!1,writable:!1,value:S}),Object.freeze&&(Object.freeze(g.props),Object.freeze(g)),g};function pt(e,r,c,p,S){{var T,y={},g=null,F=null;c!==void 0&&(Xe(c),g=""+c),ut(r)&&(Xe(r.key),g=""+r.key),ct(r)&&(F=r.ref,ft(r,S));for(T in r)ee.call(r,T)&&!lt.hasOwnProperty(T)&&(y[T]=r[T]);if(e&&e.defaultProps){var C=e.defaultProps;for(T in C)y[T]===void 0&&(y[T]=C[T])}if(g||F){var L=typeof e=="function"?e.displayName||e.name||"Unknown":e;g&&dt(y,L),F&&Ie(y,L)}return mt(e,g,F,S,p,Qe.current,y)}}var H=M.ReactCurrentOwner,qe=M.ReactDebugCurrentFrame;function Z(e){if(e){var r=e._owner,c=ve(e.type,e._source,r?r.type:null);qe.setExtraStackFrame(c)}else qe.setExtraStackFrame(null)}var t;t=!1;function n(e){return typeof e=="object"&&e!==null&&e.$$typeof===d}function a(){{if(H.current){var e=D(H.current.type);if(e)return`

Check the render method of \``+e+"`."}return""}}function i(e){return""}var l={};function s(e){{var r=a();if(!r){var c=typeof e=="string"?e:e.displayName||e.name;c&&(r=`

Check the top-level render call using <`+c+">.")}return r}}function h(e,r){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var c=s(r);if(l[c])return;l[c]=!0;var p="";e&&e._owner&&e._owner!==H.current&&(p=" It was passed a child from "+D(e._owner.type)+"."),Z(e),O('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',c,p),Z(null)}}function _(e,r){{if(typeof e!="object")return;if(ce(e))for(var c=0;c<e.length;c++){var p=e[c];n(p)&&h(p,r)}else if(n(e))e._store&&(e._store.validated=!0);else if(e){var S=Be(e);if(typeof S=="function"&&S!==e.entries)for(var T=S.call(e),y;!(y=T.next()).done;)n(y.value)&&h(y.value,r)}}}function N(e){{var r=e.type;if(r==null||typeof r=="string")return;var c;if(typeof r=="function")c=r.propTypes;else if(typeof r=="object"&&(r.$$typeof===b||r.$$typeof===U))c=r.propTypes;else return;if(c){var p=D(r);ze(c,e.props,"prop",p,e)}else if(r.PropTypes!==void 0&&!t){t=!0;var S=D(r);O("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",S||"Unknown")}typeof r.getDefaultProps=="function"&&!r.getDefaultProps.isReactClassApproved&&O("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function k(e){{for(var r=Object.keys(e.props),c=0;c<r.length;c++){var p=r[c];if(p!=="children"&&p!=="key"){Z(e),O("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",p),Z(null);break}}e.ref!==null&&(Z(e),O("Invalid attribute `ref` supplied to `React.Fragment`."),Z(null))}}var j={};function te(e,r,c,p,S,T){{var y=De(e);if(!y){var g="";(e===void 0||typeof e=="object"&&e!==null&&Object.keys(e).length===0)&&(g+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var F=i();F?g+=F:g+=a();var C;e===null?C="null":ce(e)?C="array":e!==void 0&&e.$$typeof===d?(C="<"+(D(e.type)||"Unknown")+" />",g=" Did you accidentally export a JSX literal instead of a component?"):C=typeof e,O("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",C,g)}var L=pt(e,r,c,S,T);if(L==null)return L;if(y){var z=r.children;if(z!==void 0)if(p)if(ce(z)){for(var xe=0;xe<z.length;xe++)_(z[xe],e);Object.freeze&&Object.freeze(z)}else O("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else _(z,e)}if(ee.call(r,"key")){var ye=D(e),Y=Object.keys(r).filter(function(Gt){return Gt!=="key"}),vt=Y.length>0?"{key: someKey, "+Y.join(": ..., ")+": ...}":"{key: someKey}";if(!j[ye+vt]){var Jt=Y.length>0?"{"+Y.join(": ..., ")+": ...}":"{}";O(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,vt,ye,Jt,ye),j[ye+vt]=!0}}return e===m?k(L):N(L),L}}function I(e,r,c){return te(e,r,c,!0)}function Fe(e,r,c){return te(e,r,c,!1)}var ht=Fe,Wt=I;Ce.Fragment=m,Ce.jsx=ht,Ce.jsxs=Wt}()),Ce}process.env.NODE_ENV==="production"?$e.exports=Ct():$e.exports=Nt();var f=$e.exports;const we={},yt="/api/imu/latest",kt="/api/imu/history",Ye=12,Lt=1e3,et="dodec-labels",wt=["dodeca-labels"],Et="dodec-activity-log",Dt="Side",Ot=24*60*60*1e3,tt="DODEC_LABEL_UPDATE",St="DODEC_LABELS_REQUEST",_t=(()=>{const u=we==null?void 0:we.VITE_DEVICE_LABELS_URL;if(u&&u.length>0)return u;try{const d=new URL(yt,"https://placeholder.local");return`${d.origin==="https://placeholder.local"?"":`${d.protocol}//${d.host}`}/api/labels`}catch{return"/api/labels"}})(),nt=(we==null?void 0:we.VITE_DEVICE_ACTIVITY_LOG_URL)??"/api/activity-log",Pt=5*60*1e3,Tt=u=>{const d={};if(!u||typeof u!="object")return d;for(const[v,m]of Object.entries(u)){if(typeof v!="string"||v.length===0||!m||typeof m!="object")continue;const w={};for(const[P,R]of Object.entries(m)){if(typeof P!="string"||P.length===0)continue;let E=0,b=null;if(typeof R=="number")E=Number.isFinite(R)&&R>0?Math.floor(R):0;else if(R&&typeof R=="object"){const A=R.totalMs,x=R.side;typeof A=="number"&&Number.isFinite(A)&&A>0&&(E=Math.floor(A)),typeof x=="number"&&Number.isFinite(x)&&(b=Math.floor(x))}(E>0||b!==null)&&(w[P]={totalMs:E,side:b})}Object.keys(w).length>0&&(d[v]=w)}return d},At=Array.from({length:Ye},(u,d)=>d+1),rt=()=>{const u={};for(const d of At)u[d]="";return u},Mt=()=>{if(typeof window>"u")return rt();const u=v=>{try{const m=window.localStorage.getItem(v);if(!m)return null;const w=JSON.parse(m),P=rt();for(const[R,E]of Object.entries(w)){const b=Number(R);Number.isFinite(b)&&b>=1&&b<=Ye&&(P[b]=String(E??""))}return P}catch(m){return console.warn("Unable to read stored labels",m),null}},d=u(et);if(d)return d;for(const v of wt){const m=u(v);if(m){try{window.localStorage.setItem(et,JSON.stringify(m))}catch{}return m}}return rt()},Rt=()=>({currentLabel:null,startTime:null,lastTimestamp:null,lastSide:null}),at=(u,d)=>{var m;const v=(m=u[d])==null?void 0:m.trim();return v&&v.length>0?v:`${Dt} ${d}`},It=u=>{const d=[u.received_at,u.imu_timestamp_iso];for(const v of d)if(v){const m=Date.parse(v);if(!Number.isNaN(m))return m}if(u.imu_timestamp_text){const v=u.imu_timestamp_text.replace(" ","T"),m=Date.parse(v);if(!Number.isNaN(m))return m}return Date.now()},Ft=u=>{if(!u)return null;const d=Date.parse(u);return Number.isNaN(d)?null:d},Ee=u=>{const d=new Date(u),v=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),w=String(d.getDate()).padStart(2,"0");return`${v}-${m}-${w}`},Ne=u=>{const[d,v,m]=u.split("-").map(Number);return new Date(d,v-1,m)},Ue=u=>{const d=Ne(u),v=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(),m=v+Ot;return{start:v,end:m}},xt=u=>{const d=Ne(u);return new Intl.DateTimeFormat(void 0,{dateStyle:"medium"}).format(d)},Yt=u=>u?u.replace("T"," ").replace(/\+.*$/,""):"Waiting for data?",ke=u=>{if(!Number.isFinite(u)||u<=0)return"00:00";const d=Math.floor(u/1e3),v=Math.floor(d/3600),m=Math.floor(d%3600/60),w=d%60;return v>0?`${String(v).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(w).padStart(2,"0")}`:`${String(m).padStart(2,"0")}:${String(w).padStart(2,"0")}`},Ut=u=>ke(u),Vt=u=>{const d=u.trim();if(!d)return NaN;const v=d.split(":");if(v.length>1){if(v.length>3)return NaN;const w=v.map(b=>Number(b));if(w.some(b=>Number.isNaN(b)||b<0))return NaN;let P=0,R=0,E=0;return w.length===3?[P,R,E]=w:[R,E]=w,Math.max(0,P*3600+R*60+E)*1e3}const m=Number(d);return Number.isNaN(m)||m<0?NaN:m*60*1e3},st=u=>u.includes('"')||u.includes(",")||u.includes(`
`)?`"${u.replace(/"/g,'""')}"`:u;function Bt(){const[u,d]=o.useState(null),[v,m]=o.useState(null),[w,P]=o.useState(()=>{if(typeof window>"u")return{};try{const t=window.localStorage.getItem(Et);return t?Tt(JSON.parse(t)):{}}catch(t){return console.warn("Unable to read stored activity log",t),{}}}),R=o.useRef(w),[E,b]=o.useState(null),[A,x]=o.useState(""),[U,V]=o.useState(""),[fe,G]=o.useState(null),[Ve,Be]=o.useState(()=>[Ee(Date.now())]),[M,O]=o.useState("week"),[Se,ot]=o.useState(Ee(Date.now())),[_e,it]=o.useState(Ee(Date.now())),[We,Le]=o.useState(null),[de,De]=o.useState(!1),[Oe,ne]=o.useState(null),[D,K]=o.useState(()=>Mt()),re=o.useRef(D),me=o.useRef(!1),se=o.useRef({}),q=o.useRef(null),X=o.useRef(Rt()),[Pe,Je]=o.useState(!1),[Q,Te]=o.useState(!1),[jt,Ge]=o.useState(!1),B=o.useRef(!1),$=o.useRef(!1),oe=o.useRef(0),pe=o.useRef(!1),ae=o.useCallback(()=>{B.current||(B.current=!0,Ge(!0))},[]),he=o.useCallback(()=>{B.current&&(B.current=!1,Ge(!1))},[]),W=o.useCallback((t,n)=>{P(a=>{const i=t(a);return R.current=i,((n==null?void 0:n.markDirty)??!0)&&i!==a&&(Q||($.current=!0),ae()),i})},[Q,ae]),ie=o.useCallback(async t=>{const n=(t==null?void 0:t.allowSkip)??!0,a=oe.current+1;oe.current=a;const i=await fetch(nt,{cache:"no-store"});if(!i.ok)throw new Error(`Activity log request failed with status ${i.status}`);const l=await i.json();if(a!==oe.current)return!1;if(l&&typeof l=="object"&&l.entries){if(n&&$.current)return console.warn("[activity-log] skipped applying remote log because local edits occurred first"),$.current=!1,Te(!0),B.current||he(),!1;pe.current=!0,W(()=>Tt(l.entries),{markDirty:!1})}return $.current=!1,Te(!0),B.current||he(),!0},[W,he]);o.useEffect(()=>{R.current=w},[w]);const He=o.useCallback((t,n,a,i)=>{i<=a||W(l=>{const s={...l};let h=a;for(;h<i;){const _=Ee(h),{end:N}=Ue(_),k=Math.min(i,N),j=Math.max(0,k-h);if(j>0){const te={...s[_]??{}},I=te[t],Fe=((I==null?void 0:I.totalMs)??0)+j,ht=n??(I==null?void 0:I.side)??null;te[t]={totalMs:Fe,side:ht},s[_]=te}h=k}return s})},[W]),ve=o.useCallback(()=>{X.current=Rt(),W(()=>({}))},[W]),ee=o.useCallback(t=>{const n=typeof t.side=="number"?t.side:null;if(!n)return;const a=at(re.current,n),i=It(t),l=t.segment_started_at?Ft(t.segment_started_at):null,s=X.current;if(s.currentLabel===null||s.startTime===null){s.currentLabel=a,s.startTime=l??i,s.lastTimestamp=i,s.lastSide=n;return}if(a===s.currentLabel){l!==null&&(s.startTime===null||l<s.startTime)&&(s.startTime=l),s.lastTimestamp=i,s.lastSide=n;return}const h=s.startTime,_=i;_>h&&He(s.currentLabel,s.lastSide,h,_),s.currentLabel=a,s.startTime=l??i,s.lastTimestamp=i,s.lastSide=n},[He]);o.useEffect(()=>{if(re.current=D,typeof window<"u"){const n=JSON.stringify(D);window.localStorage.setItem(et,n);for(const a of wt)window.localStorage.setItem(a,n);!me.current&&window.parent&&window.parent!==window&&window.parent.postMessage({type:tt,labels:D},"*")}me.current=!1;const t=X.current;t.lastSide!==null&&(t.currentLabel=at(D,t.lastSide))},[D]),o.useEffect(()=>{typeof window<"u"&&window.localStorage.setItem(Et,JSON.stringify(w))},[w]),o.useEffect(()=>{let t=!1;return(async()=>{try{await ie({allowSkip:!0})}catch(a){t||(console.warn("[activity-log] failed to load activity log from server",a),$.current=!1,Te(!0))}})(),()=>{t=!0}},[ie]),o.useEffect(()=>()=>{if(!(typeof window>"u")){for(const t of Object.keys(se.current)){const n=se.current[Number(t)];typeof n=="number"&&window.clearTimeout(n)}q.current!==null&&window.clearTimeout(q.current)}},[]),o.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(_t,{cache:"no-store"});if(!a.ok)throw new Error(`Failed to load labels (status ${a.status})`);const i=await a.json();if(t||!i||typeof i.labels!="object"||i.labels===null)return;me.current=!0,K(l=>{const s={...l};let h=!1;for(const[_,N]of Object.entries(i.labels)){const k=Number(_);if(!Number.isFinite(k)||k<1||k>Ye)continue;const j=typeof N=="string"?N:"";s[k]!==j&&(s[k]=j,h=!0)}return h?s:l})}catch(a){console.error("[timesheet-app] failed to load labels from server",a)}})(),()=>{t=!0}},[]),o.useEffect(()=>{if(typeof window>"u")return;const t=n=>{const a=n==null?void 0:n.data;if(!(!a||typeof a!="object"))if(a.type===tt&&a.labels&&typeof a.labels=="object"){me.current=!0;const i=a.labels;K(l=>{const s={...l};for(const[h,_]of Object.entries(i)){const N=Number(h);!Number.isFinite(N)||N<1||N>Ye||(s[N]=typeof _=="string"?_:"")}return{...s}})}else a.type===St&&window.parent&&window.parent!==window&&window.parent.postMessage({type:tt,labels:re.current},n.origin||"*")};return window.addEventListener("message",t),window.parent&&window.parent!==window&&window.parent.postMessage({type:St},"*"),()=>{window.removeEventListener("message",t)}},[]),o.useEffect(()=>{let t=!1;return(async()=>{try{const a=await fetch(`${kt}?limit=5000`,{cache:"no-store"});if(!a.ok)throw new Error(`History request failed with status ${a.status}`);const i=await a.json();if(t)return;ve();let l=null;for(const s of i){if(t)break;ee(s),l=s}l&&d({side:typeof l.side=="number"?l.side:null,imu_timestamp_text:l.imu_timestamp_text??null,imu_timestamp_iso:l.imu_timestamp_iso??null,received_at:l.received_at??null,confidence:l.confidence??null}),m(null)}catch(a){t||m(a instanceof Error?a.message:"Unknown error while loading history")}finally{t||Je(!0)}})(),()=>{t=!0}},[ee,ve]),o.useEffect(()=>{if(!Pe)return;let t=!0;const n=async()=>{try{const i=await fetch(yt,{cache:"no-store"});if(!i.ok)throw new Error(`Request failed with status ${i.status}`);const l=await i.json();if(!t)return;ee(l),d({side:typeof l.side=="number"?l.side:null,imu_timestamp_text:l.imu_timestamp_text??null,imu_timestamp_iso:l.imu_timestamp_iso??null,received_at:l.received_at??null,confidence:l.confidence??null}),m(null)}catch(i){t&&m(i instanceof Error?i.message:"Unknown error")}};n();const a=window.setInterval(n,Lt);return()=>{t=!1,window.clearInterval(a)}},[ee,Pe]);const Ae=X.current,J=Ae.lastTimestamp?Ee(Ae.lastTimestamp):Ee(Date.now());o.useEffect(()=>{Be(t=>t.includes(J)?t:[...t,J])},[J]);const le=o.useCallback(async(t,n)=>{try{const a=await fetch(`${_t.replace(/\/$/,"")}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:n})});if(!a.ok)throw new Error(`Failed to persist label (status ${a.status})`)}catch(a){console.error(`[timesheet-app] failed to persist label for side ${t}`,a)}},[]),ze=o.useCallback((t,n)=>{const a=n.trim();if(typeof window>"u"){le(t,a);return}const i=se.current[t];typeof i=="number"&&window.clearTimeout(i),se.current[t]=window.setTimeout(()=>{se.current[t]=null,le(t,a)},400)},[le]);o.useCallback(t=>n=>{const a=n.target.value;K(i=>({...i,[t]:a})),ze(t,a)},[ze]);const ge=(t,n)=>{const a=X.current;if(!a.currentLabel||a.currentLabel!==n||a.startTime===null||a.lastTimestamp===null)return 0;const{start:i,end:l}=Ue(t),s=Math.max(i,a.startTime),h=Math.min(l,a.lastTimestamp);return h>s?h-s:0},ce=o.useCallback(t=>{const n=w[t]??{},a=Object.entries(n).map(([l,s])=>({label:l,totalMs:s.totalMs,side:s.side??null})),i=X.current;if(i.currentLabel&&i.startTime!==null&&i.lastTimestamp!==null){const l=ge(t,i.currentLabel);if(l>0){const s=a.find(_=>_.label===i.currentLabel),h=i.lastSide;s?(s.totalMs+=l,s.side===null&&(s.side=h)):a.push({label:i.currentLabel,totalMs:l,side:h??null})}}return a.sort((l,s)=>s.totalMs-l.totalMs)},[w,u]),Re=o.useMemo(()=>{const t=new Set(Object.keys(w));return t.add(J),Array.from(t).sort((n,a)=>n===a?0:n>a?-1:1)},[w,J]),Me=o.useMemo(()=>Re.map(t=>{const n=ce(t);if(n.length===0)return null;const a=n.reduce((i,l)=>i+l.totalMs,0);return{dateKey:t,rows:n,totalMs:a}}).filter(Boolean),[Re,ce]),Ke=o.useCallback((t,n,a)=>{if(X.current.currentLabel===n&&t===J){G("Stop the current activity before editing it.");return}b({dateKey:t,originalLabel:n}),x(Ut(a)),V(n),G(null)},[J]),Xe=o.useCallback(t=>{x(t.target.value)},[]),Qe=o.useCallback(t=>{V(t.target.value)},[]),lt=o.useCallback(()=>{b(null),x(""),V(""),G(null)},[]),be=o.useCallback(()=>{if(!E)return!0;const{dateKey:t,originalLabel:n}=E,a=Vt(A);if(!Number.isFinite(a))return G("Please enter duration as mm:ss, hh:mm:ss, or minutes."),!1;const i=U.trim();if(i.length===0)return G("Activity name cannot be empty."),!1;const l=ge(t,n);if(a<l)return G(`Duration cannot be less than the active segment (${ke(l)}).`),!1;const s=Math.max(0,a-l);return W(h=>{const _={...h},N={..._[t]??{}},k=N[n];if(k&&delete N[n],s>0){const j=N[i],te=((j==null?void 0:j.totalMs)??0)+s,I=i===n?(k==null?void 0:k.side)??(j==null?void 0:j.side)??null:(j==null?void 0:j.side)??(k==null?void 0:k.side)??null;N[i]={totalMs:te,side:I}}return Object.keys(N).length===0?delete _[t]:_[t]=N,_}),b(null),x(""),V(""),G(null),!0},[W,E,A,U,ge]),Ze=o.useCallback(()=>{be()},[be]),ct=o.useCallback((t,n)=>{if(ge(t,n)>0){G("Stop the current activity before deleting it.");return}W(i=>{const l=i[t];if(!l||!(n in l))return i;const s={...i},h={...l};return delete h[n],Object.keys(h).length===0?delete s[t]:s[t]=h,s}),E&&E.dateKey===t&&E.originalLabel===n&&(b(null),x(""),V("")),G(null)},[W,E,ge]),ut=o.useCallback(t=>{Be(n=>n.includes(t)?n.filter(a=>a!==t):[...n,t])},[]),ft=()=>{if(M==="week"){const{start:l,end:s}=Ue(J),h=new Date(l);return h.setDate(h.getDate()-6),{start:new Date(h.getFullYear(),h.getMonth(),h.getDate()).getTime(),end:s}}if(M==="month"){const l=Ne(J),s=new Date(l.getFullYear(),l.getMonth(),1).getTime(),h=new Date(l.getFullYear(),l.getMonth()+1,1).getTime();return{start:s,end:h}}const t=Ne(Se),n=Ne(_e);if(Number.isNaN(t.getTime())||Number.isNaN(n.getTime())||t>n)return null;const a=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime(),i=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1).getTime();return{start:a,end:i}},dt=o.useCallback(()=>{const t=ft();if(!t){Le("Please provide a valid date range before downloading.");return}const n=[];for(const _ of Re){const{start:N,end:k}=Ue(_);if(k<=t.start||N>=t.end)continue;const j=ce(_);if(j.length===0)continue;const te=xt(_);for(const I of j){const Fe=I.side!==null?`Side ${I.side}`:"";n.push(`${st(te)},${st(I.label)},${st(Fe)},${ke(I.totalMs)}`)}}if(n.length===0){Le("No activity recorded in the selected range.");return}const a=["Date,Activity,Side,Duration",...n].join(`
`),i=new Blob([a],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(i),s=document.createElement("a");s.href=l;const h=M==="custom"?"custom":M;s.download=`activity-log-${h}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(l),Le(null)},[ce,M,Re,Se,_e]),Ie=(u==null?void 0:u.side)??null,mt=o.useMemo(()=>Ie===null?null:at(D,Ie),[Ie,D]),pt=(u==null?void 0:u.imu_timestamp_text)??(u==null?void 0:u.imu_timestamp_iso)??(u==null?void 0:u.received_at)??null,H=o.useCallback(async(t=!1)=>{if(!t&&(!Q||!B.current))return!1;const n=R.current;try{const a=await fetch(nt,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({entries:n})});if(!a.ok)throw new Error(`Activity log sync failed with status ${a.status}`);return he(),!0}catch(a){return console.warn("[activity-log] failed to sync activity log",a),!1}},[he,Q]),qe=o.useCallback(async()=>{if(de)return;if(De(!0),ne(null),typeof window<"u"&&q.current!==null&&(window.clearTimeout(q.current),q.current=null),!be()){ne({type:"error",message:"Please finish editing or fix validation errors before saving."}),De(!1);return}if(Q||($.current=!0),ae(),await H(!0))try{await ie({allowSkip:!1}),ne({type:"success",message:"Activity log saved."}),typeof window<"u"&&(q.current=window.setTimeout(()=>{ne(null),q.current=null},4e3))}catch(a){console.warn("[activity-log] failed to refresh activity log after manual save",a),ne({type:"error",message:"Saved, but failed to refresh from server. Please reload to verify."})}else ne({type:"error",message:"Unable to save activity log. Please try again."});De(!1)},[be,ie,Q,de,ae,H]);o.useEffect(()=>{if(pe.current){pe.current=!1;return}B.current&&(async()=>{if(await H(!0))try{await ie({allowSkip:!1})}catch(n){console.warn("[activity-log] failed to refresh activity log after background sync",n)}})()},[w,ie,H]),o.useEffect(()=>{if(!Q||typeof window>"u")return;const t=window.setInterval(()=>{H()},Pt);return()=>window.clearInterval(t)},[Q,H]),o.useEffect(()=>{if(typeof window>"u")return;const t=()=>{if(B.current){if(navigator.sendBeacon)try{const n=new Blob([JSON.stringify({entries:R.current})],{type:"application/json"});navigator.sendBeacon(nt,n);return}catch(n){console.warn("[activity-log] sendBeacon flush failed",n)}H(!0)}};return window.addEventListener("pagehide",t),window.addEventListener("beforeunload",t),()=>{window.removeEventListener("pagehide",t),window.removeEventListener("beforeunload",t)}},[H]);const Z=o.useCallback(()=>{var i,l,s;if(typeof window>"u"||window.parent===window)return;const t=window.document,n=((i=t.documentElement)==null?void 0:i.scrollHeight)||((l=t.body)==null?void 0:l.scrollHeight)||window.innerHeight,a=Math.max(320,Math.min(Math.ceil(n),4e3));(s=window.parent)==null||s.postMessage({type:"EMBED_HEIGHT",height:a},"*")},[]);return o.useEffect(()=>{Z()},[Z,Me.length,Ve,D,E,M]),o.useEffect(()=>{if(typeof window>"u")return;const t=()=>Z();window.addEventListener("load",t),window.addEventListener("resize",t);let n=null;return typeof ResizeObserver<"u"&&(n=new ResizeObserver(t),n.observe(window.document.documentElement)),()=>{window.removeEventListener("load",t),window.removeEventListener("resize",t),n==null||n.disconnect()}},[Z]),f.jsxs("div",{className:"app-shell",children:[f.jsxs("header",{className:"app-header",children:[f.jsx("h1",{children:"Do-Decahedron Orientation"}),f.jsxs("p",{className:"status-line",children:[f.jsx("span",{className:"status-label",children:"Latest IMU update:"}),f.jsx("span",{className:"status-value",children:Yt(pt)})]}),f.jsxs("p",{className:"status-line",children:[f.jsx("span",{className:"status-label",children:"Current activity:"}),f.jsx("span",{className:"status-value",children:mt??"Waiting for data?"})]}),v?f.jsxs("p",{className:"error-text",children:["Error: ",v]}):null]}),f.jsxs("section",{className:"activity-summary","aria-live":"polite",children:[f.jsx("h2",{children:"Activity Log"}),f.jsxs("div",{className:"range-controls",children:[f.jsxs("label",{className:"range-option",children:["Range",f.jsxs("select",{className:"range-select",value:M,onChange:t=>O(t.target.value),children:[f.jsx("option",{value:"week",children:"This week"}),f.jsx("option",{value:"month",children:"This month"}),f.jsx("option",{value:"custom",children:"Custom"})]})]}),M==="custom"?f.jsxs(f.Fragment,{children:[f.jsxs("label",{className:"range-option",children:["From",f.jsx("input",{type:"date",className:"date-input",value:Se,max:_e,onChange:t=>ot(t.target.value)})]}),f.jsxs("label",{className:"range-option",children:["To",f.jsx("input",{type:"date",className:"date-input",value:_e,min:Se,onChange:t=>it(t.target.value)})]})]}):null,f.jsx("button",{type:"button",className:"download-button push-right",onClick:dt,children:"Download CSV"}),f.jsx("button",{type:"button",className:"download-button save-button",onClick:qe,disabled:de,children:de?"Saving...":"Save Changes"})]}),We?f.jsx("p",{className:"error-text",children:We}):null,Oe?f.jsx("p",{className:Oe.type==="error"?"error-text":"success-text",children:Oe.message}):null,Me.length===0?f.jsx("p",{className:"placeholder-text",children:"No activity recorded yet."}):Me.map(({dateKey:t,rows:n,totalMs:a})=>{const i=Ve.includes(t),l=X.current;return f.jsxs("div",{className:"date-group",children:[f.jsxs("button",{type:"button",className:`date-header${i?" date-header--expanded":""}`,onClick:()=>ut(t),children:[f.jsxs("div",{className:"date-header__title",children:[f.jsx("span",{className:"date-label",children:xt(t)}),f.jsxs("span",{className:"date-summary",children:[n.length," activit",n.length===1?"y":"ies"," - ",ke(a)]})]}),f.jsx("span",{className:"date-header__icon",children:i?"−":"+"})]}),i?f.jsxs("table",{className:"activity-table",children:[f.jsx("thead",{children:f.jsxs("tr",{children:[f.jsx("th",{scope:"col",children:"Activity"}),f.jsx("th",{scope:"col",className:"side-heading",children:"Side"}),f.jsx("th",{scope:"col",children:"Total Duration"}),f.jsx("th",{scope:"col",className:"actions-heading",children:"Actions"})]})}),f.jsx("tbody",{children:n.map(s=>{const h=(E==null?void 0:E.dateKey)===t&&E.originalLabel===s.label,_=l.currentLabel===s.label&&t===J;return f.jsxs("tr",{children:[f.jsx("td",{children:h?f.jsx("input",{type:"text",className:"duration-input",value:U,onChange:Qe,placeholder:"Activity name"}):f.jsx("span",{children:s.label})}),f.jsx("td",{className:"side-cell",children:f.jsx("span",{children:s.side!==null?`Side ${s.side}`:"—"})}),f.jsx("td",{children:h?f.jsx("input",{type:"text",className:"duration-input",value:A,onChange:Xe,placeholder:"mm:ss or hh:mm:ss"}):f.jsx("span",{children:ke(s.totalMs)})}),f.jsx("td",{className:"actions-cell",children:f.jsx("div",{className:"action-buttons",children:h?f.jsxs(f.Fragment,{children:[f.jsx("button",{type:"button",className:"icon-button icon-button--primary",onClick:Ze,children:"Save"}),f.jsx("button",{type:"button",className:"icon-button",onClick:lt,children:"Cancel"})]}):f.jsxs(f.Fragment,{children:[f.jsx("button",{type:"button",className:"icon-button",disabled:_,onClick:()=>Ke(t,s.label,s.totalMs),children:"Edit"}),f.jsx("button",{type:"button",className:"icon-button icon-button--danger",disabled:_,onClick:()=>ct(t,s.label),children:"Delete"})]})})})]},`${t}-${s.label}`)})})]}):null]},t)}),fe?f.jsx("p",{className:"error-text",children:fe}):null]})]})}ue.TimesheetDevice=Bt,Object.defineProperty(ue,Symbol.toStringTag,{value:"Module"})});
