(function(X,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("react")):typeof define=="function"&&define.amd?define(["exports","react"],f):(X=typeof globalThis<"u"?globalThis:X||self,f(X.TimesheetDeviceUI={},X.React))})(this,function(X,f){"use strict";var Ae={exports:{}},me={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Qe;function mt(){if(Qe)return me;Qe=1;var l=f,d=Symbol.for("react.element"),b=Symbol.for("react.fragment"),p=Object.prototype.hasOwnProperty,S=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,L={key:!0,ref:!0,__self:!0,__source:!0};function T(D,E,I){var N,k={},W=null,A=null;I!==void 0&&(W=""+I),E.key!==void 0&&(W=""+E.key),E.ref!==void 0&&(A=E.ref);for(N in E)p.call(E,N)&&!L.hasOwnProperty(N)&&(k[N]=E[N]);if(D&&D.defaultProps)for(N in E=D.defaultProps,E)k[N]===void 0&&(k[N]=E[N]);return{$$typeof:d,type:D,key:W,ref:A,props:k,_owner:S.current}}return me.Fragment=b,me.jsx=T,me.jsxs=T,me}var pe={};/**
 * @license React
 * react-jsx-runtime.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ze;function pt(){return Ze||(Ze=1,process.env.NODE_ENV!=="production"&&function(){var l=f,d=Symbol.for("react.element"),b=Symbol.for("react.portal"),p=Symbol.for("react.fragment"),S=Symbol.for("react.strict_mode"),L=Symbol.for("react.profiler"),T=Symbol.for("react.provider"),D=Symbol.for("react.context"),E=Symbol.for("react.forward_ref"),I=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),k=Symbol.for("react.memo"),W=Symbol.for("react.lazy"),A=Symbol.for("react.offscreen"),je=Symbol.iterator,Ce="@@iterator";function G(e){if(e===null||typeof e!="object")return null;var n=je&&e[je]||e[Ce];return typeof n=="function"?n:null}var H=l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function j(e){{for(var n=arguments.length,o=new Array(n>1?n-1:0),m=1;m<n;m++)o[m-1]=arguments[m];Ve("error",e,o)}}function Ve(e,n,o){{var m=H.ReactDebugCurrentFrame,y=m.getStackAddendum();y!==""&&(n+="%s",o=o.concat([y]));var w=o.map(function(g){return String(g)});w.unshift("Warning: "+n),Function.prototype.apply.call(console[e],console,w)}}var te=!1,We=!1,De=!1,be=!1,B=!1,ne;ne=Symbol.for("react.module.reference");function ge(e){return!!(typeof e=="string"||typeof e=="function"||e===p||e===L||B||e===S||e===I||e===N||be||e===A||te||We||De||typeof e=="object"&&e!==null&&(e.$$typeof===W||e.$$typeof===k||e.$$typeof===T||e.$$typeof===D||e.$$typeof===E||e.$$typeof===ne||e.getModuleId!==void 0))}function re(e,n,o){var m=e.displayName;if(m)return m;var y=n.displayName||n.name||"";return y!==""?o+"("+y+")":o}function K(e){return e.displayName||"Context"}function O(e){if(e==null)return null;if(typeof e.tag=="number"&&j("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case p:return"Fragment";case b:return"Portal";case L:return"Profiler";case S:return"StrictMode";case I:return"Suspense";case N:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case D:var n=e;return K(n)+".Consumer";case T:var o=e;return K(o._context)+".Provider";case E:return re(e,e.render,"ForwardRef");case k:var m=e.displayName||null;return m!==null?m:O(e.type)||"Memo";case W:{var y=e,w=y._payload,g=y._init;try{return O(g(w))}catch{return null}}}return null}var J=Object.assign,Q=0,ye,Ee,Z,we,M,q,ae;function _e(){}_e.__reactDisabledLog=!0;function se(){{if(Q===0){ye=console.log,Ee=console.info,Z=console.warn,we=console.error,M=console.group,q=console.groupCollapsed,ae=console.groupEnd;var e={configurable:!0,enumerable:!0,value:_e,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}Q++}}function oe(){{if(Q--,Q===0){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:J({},e,{value:ye}),info:J({},e,{value:Ee}),warn:J({},e,{value:Z}),error:J({},e,{value:we}),group:J({},e,{value:M}),groupCollapsed:J({},e,{value:q}),groupEnd:J({},e,{value:ae})})}Q<0&&j("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}}var ie=H.ReactCurrentDispatcher,Se;function le(e,n,o){{if(Se===void 0)try{throw Error()}catch(y){var m=y.stack.trim().match(/\n( *(at )?)/);Se=m&&m[1]||""}return`
`+Se+e}}var Te=!1,ce;{var Be=typeof WeakMap=="function"?WeakMap:Map;ce=new Be}function Ne(e,n){if(!e||Te)return"";{var o=ce.get(e);if(o!==void 0)return o}var m;Te=!0;var y=Error.prepareStackTrace;Error.prepareStackTrace=void 0;var w;w=ie.current,ie.current=null,se();try{if(n){var g=function(){throw Error()};if(Object.defineProperty(g.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(g,[])}catch(F){m=F}Reflect.construct(e,[],g)}else{try{g.call()}catch(F){m=F}e.call(g.prototype)}}else{try{throw Error()}catch(F){m=F}e()}}catch(F){if(F&&m&&typeof F.stack=="string"){for(var v=F.stack.split(`
`),P=m.stack.split(`
`),R=v.length-1,C=P.length-1;R>=1&&C>=0&&v[R]!==P[C];)C--;for(;R>=1&&C>=0;R--,C--)if(v[R]!==P[C]){if(R!==1||C!==1)do if(R--,C--,C<0||v[R]!==P[C]){var V=`
`+v[R].replace(" at new "," at ");return e.displayName&&V.includes("<anonymous>")&&(V=V.replace("<anonymous>",e.displayName)),typeof e=="function"&&ce.set(e,V),V}while(R>=1&&C>=0);break}}}finally{Te=!1,ie.current=w,oe(),Error.prepareStackTrace=y}var de=e?e.displayName||e.name:"",$=de?le(de):"";return typeof e=="function"&&ce.set(e,$),$}function Je(e,n,o){return Ne(e,!1)}function Ge(e){var n=e.prototype;return!!(n&&n.isReactComponent)}function ue(e,n,o){if(e==null)return"";if(typeof e=="function")return Ne(e,Ge(e));if(typeof e=="string")return le(e);switch(e){case I:return le("Suspense");case N:return le("SuspenseList")}if(typeof e=="object")switch(e.$$typeof){case E:return Je(e.render);case k:return ue(e.type,n,o);case W:{var m=e,y=m._payload,w=m._init;try{return ue(w(y),n,o)}catch{}}}return""}var z=Object.prototype.hasOwnProperty,Oe={},Le=H.ReactDebugCurrentFrame;function t(e){if(e){var n=e._owner,o=ue(e.type,e._source,n?n.type:null);Le.setExtraStackFrame(o)}else Le.setExtraStackFrame(null)}function a(e,n,o,m,y){{var w=Function.call.bind(z);for(var g in e)if(w(e,g)){var v=void 0;try{if(typeof e[g]!="function"){var P=Error((m||"React class")+": "+o+" type `"+g+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[g]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw P.name="Invariant Violation",P}v=e[g](n,g,m,o,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(R){v=R}v&&!(v instanceof Error)&&(t(y),j("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",m||"React class",o,g,typeof v),t(null)),v instanceof Error&&!(v.message in Oe)&&(Oe[v.message]=!0,t(y),j("Failed %s type: %s",o,v.message),t(null))}}}var r=Array.isArray;function c(e){return r(e)}function i(e){{var n=typeof Symbol=="function"&&Symbol.toStringTag,o=n&&e[Symbol.toStringTag]||e.constructor.name||"Object";return o}}function s(e){try{return h(e),!1}catch{return!0}}function h(e){return""+e}function _(e){if(s(e))return j("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",i(e)),h(e)}var x=H.ReactCurrentOwner,Y={key:!0,ref:!0,__self:!0,__source:!0},U,ke;function Pe(e){if(z.call(e,"ref")){var n=Object.getOwnPropertyDescriptor(e,"ref").get;if(n&&n.isReactWarning)return!1}return e.ref!==void 0}function jt(e){if(z.call(e,"key")){var n=Object.getOwnPropertyDescriptor(e,"key").get;if(n&&n.isReactWarning)return!1}return e.key!==void 0}function Ct(e,n){typeof e.ref=="string"&&x.current}function Dt(e,n){{var o=function(){U||(U=!0,j("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",n))};o.isReactWarning=!0,Object.defineProperty(e,"key",{get:o,configurable:!0})}}function Nt(e,n){{var o=function(){ke||(ke=!0,j("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",n))};o.isReactWarning=!0,Object.defineProperty(e,"ref",{get:o,configurable:!0})}}var Ot=function(e,n,o,m,y,w,g){var v={$$typeof:d,type:e,key:n,ref:o,props:g,_owner:w};return v._store={},Object.defineProperty(v._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(v,"_self",{configurable:!1,enumerable:!1,writable:!1,value:m}),Object.defineProperty(v,"_source",{configurable:!1,enumerable:!1,writable:!1,value:y}),Object.freeze&&(Object.freeze(v.props),Object.freeze(v)),v};function Lt(e,n,o,m,y){{var w,g={},v=null,P=null;o!==void 0&&(_(o),v=""+o),jt(n)&&(_(n.key),v=""+n.key),Pe(n)&&(P=n.ref,Ct(n,y));for(w in n)z.call(n,w)&&!Y.hasOwnProperty(w)&&(g[w]=n[w]);if(e&&e.defaultProps){var R=e.defaultProps;for(w in R)g[w]===void 0&&(g[w]=R[w])}if(v||P){var C=typeof e=="function"?e.displayName||e.name||"Unknown":e;v&&Dt(g,C),P&&Nt(g,C)}return Ot(e,v,P,y,m,x.current,g)}}var ze=H.ReactCurrentOwner,ot=H.ReactDebugCurrentFrame;function fe(e){if(e){var n=e._owner,o=ue(e.type,e._source,n?n.type:null);ot.setExtraStackFrame(o)}else ot.setExtraStackFrame(null)}var He;He=!1;function Ke(e){return typeof e=="object"&&e!==null&&e.$$typeof===d}function it(){{if(ze.current){var e=O(ze.current.type);if(e)return`

Check the render method of \``+e+"`."}return""}}function kt(e){return""}var lt={};function Pt(e){{var n=it();if(!n){var o=typeof e=="string"?e:e.displayName||e.name;o&&(n=`

Check the top-level render call using <`+o+">.")}return n}}function ct(e,n){{if(!e._store||e._store.validated||e.key!=null)return;e._store.validated=!0;var o=Pt(n);if(lt[o])return;lt[o]=!0;var m="";e&&e._owner&&e._owner!==ze.current&&(m=" It was passed a child from "+O(e._owner.type)+"."),fe(e),j('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',o,m),fe(null)}}function ut(e,n){{if(typeof e!="object")return;if(c(e))for(var o=0;o<e.length;o++){var m=e[o];Ke(m)&&ct(m,n)}else if(Ke(e))e._store&&(e._store.validated=!0);else if(e){var y=G(e);if(typeof y=="function"&&y!==e.entries)for(var w=y.call(e),g;!(g=w.next()).done;)Ke(g.value)&&ct(g.value,n)}}}function At(e){{var n=e.type;if(n==null||typeof n=="string")return;var o;if(typeof n=="function")o=n.propTypes;else if(typeof n=="object"&&(n.$$typeof===E||n.$$typeof===k))o=n.propTypes;else return;if(o){var m=O(n);a(o,e.props,"prop",m,e)}else if(n.PropTypes!==void 0&&!He){He=!0;var y=O(n);j("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",y||"Unknown")}typeof n.getDefaultProps=="function"&&!n.getDefaultProps.isReactClassApproved&&j("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function Ft(e){{for(var n=Object.keys(e.props),o=0;o<n.length;o++){var m=n[o];if(m!=="children"&&m!=="key"){fe(e),j("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",m),fe(null);break}}e.ref!==null&&(fe(e),j("Invalid attribute `ref` supplied to `React.Fragment`."),fe(null))}}var ft={};function dt(e,n,o,m,y,w){{var g=ge(e);if(!g){var v="";(e===void 0||typeof e=="object"&&e!==null&&Object.keys(e).length===0)&&(v+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports.");var P=kt();P?v+=P:v+=it();var R;e===null?R="null":c(e)?R="array":e!==void 0&&e.$$typeof===d?(R="<"+(O(e.type)||"Unknown")+" />",v=" Did you accidentally export a JSX literal instead of a component?"):R=typeof e,j("React.jsx: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",R,v)}var C=Lt(e,n,o,y,w);if(C==null)return C;if(g){var V=n.children;if(V!==void 0)if(m)if(c(V)){for(var de=0;de<V.length;de++)ut(V[de],e);Object.freeze&&Object.freeze(V)}else j("React.jsx: Static children should always be an array. You are likely explicitly calling React.jsxs or React.jsxDEV. Use the Babel transform instead.");else ut(V,e)}if(z.call(n,"key")){var $=O(e),F=Object.keys(n).filter(function(Wt){return Wt!=="key"}),Xe=F.length>0?"{key: someKey, "+F.join(": ..., ")+": ...}":"{key: someKey}";if(!ft[$+Xe]){var Vt=F.length>0?"{"+F.join(": ..., ")+": ...}":"{}";j(`A props object containing a "key" prop is being spread into JSX:
  let props = %s;
  <%s {...props} />
React keys must be passed directly to JSX without using spread:
  let props = %s;
  <%s key={someKey} {...props} />`,Xe,$,Vt,$),ft[$+Xe]=!0}}return e===p?Ft(C):At(C),C}}function Mt(e,n,o){return dt(e,n,o,!0)}function It(e,n,o){return dt(e,n,o,!1)}var Yt=It,Ut=Mt;pe.Fragment=p,pe.jsx=Yt,pe.jsxs=Ut}()),pe}process.env.NODE_ENV==="production"?Ae.exports=mt():Ae.exports=pt();var u=Ae.exports;const Fe={},qe="/api/imu/latest",ht="/api/imu/history",xe=12,vt=1e3,Me="dodec-labels",$e=["dodeca-labels"],et="dodec-activity-log",bt="Side",gt=24*60*60*1e3,Ie="DODEC_LABEL_UPDATE",tt="DODEC_LABELS_REQUEST",nt=(()=>{const l=Fe==null?void 0:Fe.VITE_DEVICE_LABELS_URL;if(l&&l.length>0)return l;try{const d=new URL(qe,"https://placeholder.local");return`${d.origin==="https://placeholder.local"?"":`${d.protocol}//${d.host}`}/api/labels`}catch{return"/api/labels"}})(),yt=Array.from({length:xe},(l,d)=>d+1),Ye=()=>{const l={};for(const d of yt)l[d]="";return l},Et=()=>{if(typeof window>"u")return Ye();const l=b=>{try{const p=window.localStorage.getItem(b);if(!p)return null;const S=JSON.parse(p),L=Ye();for(const[T,D]of Object.entries(S)){const E=Number(T);Number.isFinite(E)&&E>=1&&E<=xe&&(L[E]=String(D??""))}return L}catch(p){return console.warn("Unable to read stored labels",p),null}},d=l(Me);if(d)return d;for(const b of $e){const p=l(b);if(p){try{window.localStorage.setItem(Me,JSON.stringify(p))}catch{}return p}}return Ye()},rt=()=>({currentLabel:null,startTime:null,lastTimestamp:null,lastSide:null}),Ue=(l,d)=>{var p;const b=(p=l[d])==null?void 0:p.trim();return b&&b.length>0?b:`${bt} ${d}`},wt=l=>{const d=[l.received_at,l.imu_timestamp_iso];for(const b of d)if(b){const p=Date.parse(b);if(!Number.isNaN(p))return p}if(l.imu_timestamp_text){const b=l.imu_timestamp_text.replace(" ","T"),p=Date.parse(b);if(!Number.isNaN(p))return p}return Date.now()},_t=l=>{if(!l)return null;const d=Date.parse(l);return Number.isNaN(d)?null:d},ee=l=>{const d=new Date(l),b=d.getFullYear(),p=String(d.getMonth()+1).padStart(2,"0"),S=String(d.getDate()).padStart(2,"0");return`${b}-${p}-${S}`},he=l=>{const[d,b,p]=l.split("-").map(Number);return new Date(d,b-1,p)},Re=l=>{const d=he(l),b=new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime(),p=b+gt;return{start:b,end:p}},at=l=>{const d=he(l);return new Intl.DateTimeFormat(void 0,{dateStyle:"medium"}).format(d)},St=l=>l?l.replace("T"," ").replace(/\+.*$/,""):"Waiting for data?",ve=l=>{if(!Number.isFinite(l)||l<=0)return"00:00";const d=Math.floor(l/1e3),b=Math.floor(d/3600),p=Math.floor(d%3600/60),S=d%60;return b>0?`${String(b).padStart(2,"0")}:${String(p).padStart(2,"0")}:${String(S).padStart(2,"0")}`:`${String(p).padStart(2,"0")}:${String(S).padStart(2,"0")}`},Tt=l=>ve(l),xt=l=>{const d=l.trim();if(!d)return NaN;const b=d.split(":");if(b.length>1){if(b.length>3)return NaN;const S=b.map(E=>Number(E));if(S.some(E=>Number.isNaN(E)||E<0))return NaN;let L=0,T=0,D=0;return S.length===3?[L,T,D]=S:[T,D]=S,Math.max(0,L*3600+T*60+D)*1e3}const p=Number(d);return Number.isNaN(p)||p<0?NaN:p*60*1e3},st=l=>l.includes('"')||l.includes(",")||l.includes(`
`)?`"${l.replace(/"/g,'""')}"`:l;function Rt(){const[l,d]=f.useState(null),[b,p]=f.useState(null),[S,L]=f.useState(()=>{if(typeof window>"u")return{};try{const t=window.localStorage.getItem(et);return t?JSON.parse(t):{}}catch(t){return console.warn("Unable to read stored activity log",t),{}}}),[T,D]=f.useState(null),[E,I]=f.useState(""),[N,k]=f.useState(""),[W,A]=f.useState(null),[je,Ce]=f.useState(()=>[ee(Date.now())]),[G,H]=f.useState("week"),[j,Ve]=f.useState(ee(Date.now())),[te,We]=f.useState(ee(Date.now())),[De,be]=f.useState(null),[B,ne]=f.useState(()=>Et()),ge=f.useRef(B),re=f.useRef(!1),K=f.useRef({}),O=f.useRef(rt()),[J,Q]=f.useState(!1),ye=f.useCallback((t,a,r)=>{r<=a||L(c=>{const i={...c};let s=a;for(;s<r;){const h=ee(s),{end:_}=Re(h),x=Math.min(r,_),Y=Math.max(0,x-s);if(Y>0){const U={...i[h]??{}};U[t]=(U[t]??0)+Y,i[h]=U}s=x}return i})},[]),Ee=f.useCallback(()=>{O.current=rt(),L(()=>({}))},[]),Z=f.useCallback(t=>{const a=typeof t.side=="number"?t.side:null;if(!a)return;const r=Ue(ge.current,a),c=wt(t),i=t.segment_started_at?_t(t.segment_started_at):null,s=O.current;if(s.currentLabel===null||s.startTime===null){s.currentLabel=r,s.startTime=i??c,s.lastTimestamp=c,s.lastSide=a;return}if(r===s.currentLabel){i!==null&&(s.startTime===null||i<s.startTime)&&(s.startTime=i),s.lastTimestamp=c,s.lastSide=a;return}const h=s.startTime,_=c;_>h&&ye(s.currentLabel,h,_),s.currentLabel=r,s.startTime=i??c,s.lastTimestamp=c,s.lastSide=a},[ye]);f.useEffect(()=>{if(ge.current=B,typeof window<"u"){const a=JSON.stringify(B);window.localStorage.setItem(Me,a);for(const r of $e)window.localStorage.setItem(r,a);!re.current&&window.parent&&window.parent!==window&&window.parent.postMessage({type:Ie,labels:B},"*")}re.current=!1;const t=O.current;t.lastSide!==null&&(t.currentLabel=Ue(B,t.lastSide))},[B]),f.useEffect(()=>{typeof window<"u"&&window.localStorage.setItem(et,JSON.stringify(S))},[S]),f.useEffect(()=>()=>{if(!(typeof window>"u"))for(const t of Object.keys(K.current)){const a=K.current[Number(t)];typeof a=="number"&&window.clearTimeout(a)}},[]),f.useEffect(()=>{let t=!1;return(async()=>{try{const r=await fetch(nt,{cache:"no-store"});if(!r.ok)throw new Error(`Failed to load labels (status ${r.status})`);const c=await r.json();if(t||!c||typeof c.labels!="object"||c.labels===null)return;re.current=!0,ne(i=>{const s={...i};let h=!1;for(const[_,x]of Object.entries(c.labels)){const Y=Number(_);if(!Number.isFinite(Y)||Y<1||Y>xe)continue;const U=typeof x=="string"?x:"";s[Y]!==U&&(s[Y]=U,h=!0)}return h?s:i})}catch(r){console.error("[timesheet-app] failed to load labels from server",r)}})(),()=>{t=!0}},[]),f.useEffect(()=>{if(typeof window>"u")return;const t=a=>{const r=a==null?void 0:a.data;if(!(!r||typeof r!="object"))if(r.type===Ie&&r.labels&&typeof r.labels=="object"){re.current=!0;const c=r.labels;ne(i=>{const s={...i};for(const[h,_]of Object.entries(c)){const x=Number(h);!Number.isFinite(x)||x<1||x>xe||(s[x]=typeof _=="string"?_:"")}return{...s}})}else r.type===tt&&window.parent&&window.parent!==window&&window.parent.postMessage({type:Ie,labels:ge.current},a.origin||"*")};return window.addEventListener("message",t),window.parent&&window.parent!==window&&window.parent.postMessage({type:tt},"*"),()=>{window.removeEventListener("message",t)}},[]),f.useEffect(()=>{let t=!1;return(async()=>{try{const r=await fetch(`${ht}?limit=5000`,{cache:"no-store"});if(!r.ok)throw new Error(`History request failed with status ${r.status}`);const c=await r.json();if(t)return;Ee();let i=null;for(const s of c){if(t)break;Z(s),i=s}i&&d({side:typeof i.side=="number"?i.side:null,imu_timestamp_text:i.imu_timestamp_text??null,imu_timestamp_iso:i.imu_timestamp_iso??null,received_at:i.received_at??null,confidence:i.confidence??null}),p(null)}catch(r){t||p(r instanceof Error?r.message:"Unknown error while loading history")}finally{t||Q(!0)}})(),()=>{t=!0}},[Z,Ee]),f.useEffect(()=>{if(!J)return;let t=!0;const a=async()=>{try{const c=await fetch(qe,{cache:"no-store"});if(!c.ok)throw new Error(`Request failed with status ${c.status}`);const i=await c.json();if(!t)return;Z(i),d({side:typeof i.side=="number"?i.side:null,imu_timestamp_text:i.imu_timestamp_text??null,imu_timestamp_iso:i.imu_timestamp_iso??null,received_at:i.received_at??null,confidence:i.confidence??null}),p(null)}catch(c){t&&p(c instanceof Error?c.message:"Unknown error")}};a();const r=window.setInterval(a,vt);return()=>{t=!1,window.clearInterval(r)}},[Z,J]);const we=O.current,M=we.lastTimestamp?ee(we.lastTimestamp):ee(Date.now());f.useEffect(()=>{Ce(t=>t.includes(M)?t:[...t,M])},[M]),f.useCallback(t=>a=>{const r=a.target.value;ne(c=>({...c,[t]:r})),_e(t,r)},[_e]);const q=(t,a)=>{const r=O.current;if(!r.currentLabel||r.currentLabel!==a||r.startTime===null||r.lastTimestamp===null)return 0;const{start:c,end:i}=Re(t),s=Math.max(c,r.startTime),h=Math.min(i,r.lastTimestamp);return h>s?h-s:0},ae=f.useCallback(async(t,a)=>{try{const r=await fetch(`${nt.replace(/\/$/,"")}/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({label:a})});if(!r.ok)throw new Error(`Failed to persist label (status ${r.status})`)}catch(r){console.error(`[timesheet-app] failed to persist label for side ${t}`,r)}},[]),_e=f.useCallback((t,a)=>{const r=a.trim();if(typeof window>"u"){ae(t,r);return}const c=K.current[t];typeof c=="number"&&window.clearTimeout(c),K.current[t]=window.setTimeout(()=>{K.current[t]=null,ae(t,r)},400)},[ae]),se=f.useCallback(t=>{const a=S[t]??{},r=Object.entries(a).map(([i,s])=>({label:i,totalMs:s})),c=O.current;if(c.currentLabel&&c.startTime!==null&&c.lastTimestamp!==null){const i=q(t,c.currentLabel);if(i>0){const s=r.find(h=>h.label===c.currentLabel);s?s.totalMs+=i:r.push({label:c.currentLabel,totalMs:i})}}return r.sort((i,s)=>s.totalMs-i.totalMs)},[S,l]),oe=f.useMemo(()=>{const t=new Set(Object.keys(S));return t.add(M),Array.from(t).sort((a,r)=>a===r?0:a>r?-1:1)},[S,M]),ie=f.useMemo(()=>oe.map(t=>{const a=se(t);if(a.length===0)return null;const r=a.reduce((c,i)=>c+i.totalMs,0);return{dateKey:t,rows:a,totalMs:r}}).filter(Boolean),[oe,se]),Se=f.useCallback((t,a,r)=>{if(O.current.currentLabel===a&&t===M){A("Stop the current activity before editing it.");return}D({dateKey:t,originalLabel:a}),I(Tt(r)),k(a),A(null)},[M]),le=f.useCallback(t=>{I(t.target.value)},[]),Te=f.useCallback(t=>{k(t.target.value)},[]),ce=f.useCallback(()=>{D(null),I(""),k(""),A(null)},[]),Be=f.useCallback(()=>{if(!T)return;const{dateKey:t,originalLabel:a}=T,r=xt(E);if(!Number.isFinite(r)){A("Please enter duration as mm:ss, hh:mm:ss, or minutes.");return}const c=N.trim();if(c.length===0){A("Activity name cannot be empty.");return}const i=q(t,a);if(r<i){A(`Duration cannot be less than the active segment (${ve(i)}).`);return}const s=Math.max(0,r-i);L(h=>{const _={...h},x={..._[t]??{}};return a in x&&delete x[a],s>0&&(x[c]=(x[c]??0)+s),Object.keys(x).length===0?delete _[t]:_[t]=x,_}),D(null),I(""),k(""),A(null)},[T,E,N,q]),Ne=f.useCallback((t,a)=>{if(q(t,a)>0){A("Stop the current activity before deleting it.");return}L(c=>{const i=c[t];if(!i||!(a in i))return c;const s={...c},h={...i};return delete h[a],Object.keys(h).length===0?delete s[t]:s[t]=h,s}),T&&T.dateKey===t&&T.originalLabel===a&&(D(null),I(""),k("")),A(null)},[T]),Je=f.useCallback(t=>{Ce(a=>a.includes(t)?a.filter(r=>r!==t):[...a,t])},[]),Ge=()=>{if(G==="week"){const{start:i,end:s}=Re(M),h=new Date(i);return h.setDate(h.getDate()-6),{start:new Date(h.getFullYear(),h.getMonth(),h.getDate()).getTime(),end:s}}if(G==="month"){const i=he(M),s=new Date(i.getFullYear(),i.getMonth(),1).getTime(),h=new Date(i.getFullYear(),i.getMonth()+1,1).getTime();return{start:s,end:h}}const t=he(j),a=he(te);if(Number.isNaN(t.getTime())||Number.isNaN(a.getTime())||t>a)return null;const r=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime(),c=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1).getTime();return{start:r,end:c}},ue=f.useCallback(()=>{const t=Ge();if(!t){be("Please provide a valid date range before downloading.");return}const a=[];for(const _ of oe){const{start:x,end:Y}=Re(_);if(Y<=t.start||x>=t.end)continue;const U=se(_);if(U.length===0)continue;const ke=at(_);for(const Pe of U)a.push(`${st(ke)},${st(Pe.label)},${ve(Pe.totalMs)}`)}if(a.length===0){be("No activity recorded in the selected range.");return}const r=["Date,Activity,Duration",...a].join(`
`),c=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(c),s=document.createElement("a");s.href=i;const h=G==="custom"?"custom":G;s.download=`activity-log-${h}.csv`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),be(null)},[se,G,oe,j,te]),z=(l==null?void 0:l.side)??null,Oe=f.useMemo(()=>z===null?null:Ue(B,z),[z,B]),Le=(l==null?void 0:l.imu_timestamp_text)??(l==null?void 0:l.imu_timestamp_iso)??(l==null?void 0:l.received_at)??null;return u.jsxs("div",{className:"app-shell",children:[u.jsxs("header",{className:"app-header",children:[u.jsx("h1",{children:"Do-Decahedron Orientation"}),u.jsxs("p",{className:"status-line",children:[u.jsx("span",{className:"status-label",children:"Latest IMU update:"}),u.jsx("span",{className:"status-value",children:St(Le)})]}),u.jsxs("p",{className:"status-line",children:[u.jsx("span",{className:"status-label",children:"Current activity:"}),u.jsx("span",{className:"status-value",children:Oe??"Waiting for data?"})]}),b?u.jsxs("p",{className:"error-text",children:["Error: ",b]}):null]}),u.jsxs("section",{className:"activity-summary","aria-live":"polite",children:[u.jsx("h2",{children:"Activity Log"}),u.jsxs("div",{className:"range-controls",children:[u.jsxs("label",{className:"range-option",children:["Range",u.jsxs("select",{className:"range-select",value:G,onChange:t=>H(t.target.value),children:[u.jsx("option",{value:"week",children:"This week"}),u.jsx("option",{value:"month",children:"This month"}),u.jsx("option",{value:"custom",children:"Custom"})]})]}),G==="custom"?u.jsxs(u.Fragment,{children:[u.jsxs("label",{className:"range-option",children:["From",u.jsx("input",{type:"date",className:"date-input",value:j,max:te,onChange:t=>Ve(t.target.value)})]}),u.jsxs("label",{className:"range-option",children:["To",u.jsx("input",{type:"date",className:"date-input",value:te,min:j,onChange:t=>We(t.target.value)})]})]}):null,u.jsx("button",{type:"button",className:"download-button",onClick:ue,children:"Download CSV"})]}),De?u.jsx("p",{className:"error-text",children:De}):null,ie.length===0?u.jsx("p",{className:"placeholder-text",children:"No activity recorded yet."}):ie.map(({dateKey:t,rows:a,totalMs:r})=>{const c=je.includes(t),i=O.current;return u.jsxs("div",{className:"date-group",children:[u.jsxs("button",{type:"button",className:`date-header${c?" date-header--expanded":""}`,onClick:()=>Je(t),children:[u.jsxs("div",{className:"date-header__title",children:[u.jsx("span",{className:"date-label",children:at(t)}),u.jsxs("span",{className:"date-summary",children:[a.length," activit",a.length===1?"y":"ies"," - ",ve(r)]})]}),u.jsx("span",{className:"date-header__icon",children:c?"−":"+"})]}),c?u.jsxs("table",{className:"activity-table",children:[u.jsx("thead",{children:u.jsxs("tr",{children:[u.jsx("th",{scope:"col",children:"Activity"}),u.jsx("th",{scope:"col",children:"Total Duration"}),u.jsx("th",{scope:"col",className:"actions-heading",children:"Actions"})]})}),u.jsx("tbody",{children:a.map(s=>{const h=(T==null?void 0:T.dateKey)===t&&T.originalLabel===s.label,_=i.currentLabel===s.label&&t===M;return u.jsxs("tr",{children:[u.jsx("td",{children:h?u.jsx("input",{type:"text",className:"duration-input",value:N,onChange:Te,placeholder:"Activity name"}):u.jsx("span",{children:s.label})}),u.jsx("td",{children:h?u.jsx("input",{type:"text",className:"duration-input",value:E,onChange:le,placeholder:"mm:ss or hh:mm:ss"}):u.jsx("span",{children:ve(s.totalMs)})}),u.jsx("td",{className:"actions-cell",children:u.jsx("div",{className:"action-buttons",children:h?u.jsxs(u.Fragment,{children:[u.jsx("button",{type:"button",className:"icon-button icon-button--primary",onClick:Be,children:"Save"}),u.jsx("button",{type:"button",className:"icon-button",onClick:ce,children:"Cancel"})]}):u.jsxs(u.Fragment,{children:[u.jsx("button",{type:"button",className:"icon-button",disabled:_,onClick:()=>Se(t,s.label,s.totalMs),children:"Edit"}),u.jsx("button",{type:"button",className:"icon-button icon-button--danger",disabled:_,onClick:()=>Ne(t,s.label),children:"Delete"})]})})})]},`${t}-${s.label}`)})})]}):null]},t)}),W?u.jsx("p",{className:"error-text",children:W}):null]})]})}X.TimesheetDevice=Rt,Object.defineProperty(X,Symbol.toStringTag,{value:"Module"})});
